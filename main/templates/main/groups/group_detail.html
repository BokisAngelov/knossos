{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container mx-auto">
    <!-- Header Section -->
    <a href="{% url 'group_list' %}" class="inline-flex items-left text-sm font-semibold text-blue hover:opacity-80 mt-6">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Groups List
    </a>
    <div class="flex justify-between items-center mb-6">
        
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ group.name }}</h1>
            <p class="text-sm text-gray-500">Transport Group Details</p>
        </div>
        <div class="flex space-x-3">
            {% if group.status == 'sent' %}
            <span class="inline-flex items-center px-4 py-2 border border-gray-200 shadow-sm text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </span>
            {% else %}
            <a href="{% url 'group_update' group.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            {% endif %}
            <!-- Send pickup times to customers -->
            <form method="POST" action="{% url 'group_send_pickup_times' group.pk %}" id="sendPickupTimesForm" class="inline">
                {% csrf_token %}
                <button type="submit"
                        id="sendPickupTimesBtn"
                        {% if not all_times_set or group.status == 'sent' %}disabled{% endif %}
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white
                        {% if all_times_set and group.status == 'not_sent' %}bg-green-600 hover:bg-green-700 focus:ring-green-500{% else %}bg-gray-400 cursor-not-allowed{% endif %}
                        focus:outline-none focus:ring-2 focus:ring-offset-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Send pickup times
                </button>
            </form>
            <!-- Send Group List (supplier only) -->
            <form method="POST" action="{% url 'group_send' group.pk %}" id="sendGroupForm" class="inline">
                {% csrf_token %}
                <button type="submit"
                        id="sendGroupBtn"
                        {% if not all_times_set or group.status == 'sent' %}disabled{% endif %}
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white
                        {% if all_times_set and group.status == 'not_sent' %}bg-orange-600 hover:bg-orange-700 focus:ring-orange-500{% else %}bg-gray-400 cursor-not-allowed{% endif %}
                        focus:outline-none focus:ring-2 focus:ring-offset-2">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    {% if group.status == 'sent' %}Sent{% else %}Send Group List{% endif %}
                </button>
            </form>
            <a href="{% url 'group_export_pdf' group.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export PDF
            </a>
            <a href="{% url 'group_export_csv' group.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export CSV
            </a>
        </div>
    </div>

    <!-- Group Information Card -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Group Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
                <p class="text-sm font-medium text-gray-500">Excursion</p>
                <p class="mt-1 text-sm text-gray-900">{{ group.excursion.title }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Date</p>
                <p class="mt-1 text-sm text-gray-900">{{ group.date|date:"l, F d, Y" }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Total Guests</p>
                <p class="mt-1 text-sm">
                    <span class="{% if group.is_at_capacity %}text-red-600 font-semibold{% elif group.capacity_warning %}text-yellow-600 font-semibold{% else %}text-gray-900{% endif %}">
                        {{ group.total_guests }}
                    </span>
                    {% if group.is_at_capacity %}
                        <span class="ml-1 text-xs text-red-600">(At Capacity)</span>
                    {% elif group.capacity_warning %}
                        <span class="ml-1 text-xs text-yellow-600">(Near Capacity)</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Bus</p>
                <p class="mt-1 text-sm text-gray-900">{{ group.bus.name }} - {{ group.bus.capacity }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Guide</p>
                <p class="mt-1 text-sm text-gray-900">{{ group.guide.name }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Supplier</p>
                <p class="mt-1 text-sm text-gray-900">{{ group.provider.name }} ({{ group.provider.email }})</p>
            </div>
        </div>
        
        {% if group.description %}
        <div class="mt-6">
            <p class="text-sm font-medium text-gray-500">Description</p>
            <p class="mt-1 text-sm text-gray-900">{{ group.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Guest List Card -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Guest List</h2>
            {% if not all_times_set %}
                    <span class="text-xs">* You need to set all pickup times before sending the group list</span>
                {% endif %}
        </div>
        
        {% if pickup_groups %}
        <div class="px-6 py-6">
            {% for pickup_group in pickup_groups %}
            <!-- Pickup Group Header -->
            <div class="mb-6">
                <div class="flex items-center mb-3">
                    <h3 class="text-base font-semibold text-gray-900">{{ pickup_group.pickup_group_name }}</h3>
                    <span class="ml-3 text-sm text-gray-500">({{ pickup_group.total_guests }} guests)</span>
                </div>

                {% for pickup_point in pickup_group.pickup_point_summaries %}
                <!-- Pickup Point -->
                <div class="ml-7 mb-4">
                    <div class="flex items-center mb-2 justify-between">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <h4 class="text-sm font-medium text-gray-700">{{ pickup_point.pickup_point_name }}</h4>
                            <span class="ml-2 text-xs text-gray-400">({{ pickup_point.booking_count }} bookings)</span>
                        </div>
                        
                        <!-- Pickup Time Input -->
                        <div class="flex items-center space-x-2">
                            <label class="text-xs font-medium text-gray-600">Pickup Time:</label>
                            <input type="time" 
                                   class="pickup-time-input border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500 px-2 py-1"
                                   data-pickup-point-id="{{ pickup_point.pickup_point.id }}"
                                   value="{% if pickup_point.pickup_time %}{{ pickup_point.pickup_time|time:'H:i' }}{% endif %}"
                                   {% if group.status == 'sent' %}readonly{% endif %}>
                            <span class="time-status-icon ml-1">
                                {% if pickup_point.pickup_time %}
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                {% else %}
                                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Bookings Table -->
                    <div class="ml-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Guest Name</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Adults</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Children</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Infants</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time confirmed</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                {% for booking in pickup_point.bookings %}
                                <tr class="{% cycle 'bg-white' 'bg-gray-50' %}">
                                    <td class="px-4 py-3 text-sm text-gray-500">{{ forloop.counter }}</td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ booking.guest_name }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500 text-left">
                                        {% if booking.voucher_id and booking.voucher_id.client_phone %}
                                            {{ booking.voucher_id.client_phone }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500 text-left ">{{ booking.total_adults|default:"0" }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500 text-left">{{ booking.total_kids|default:"0" }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500 text-left">{{ booking.total_infants|default:"0" }}</td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900 text-left">
                                        {{ booking.total_adults|default:0|add:booking.total_kids|default:0|add:booking.total_infants|default:0 }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-700 text-left">
                                        {% if booking.confirmTime %}
                                            {% if booking.confirm_time_at %}Yes ({{ booking.confirm_time_at|date:"d M Y H:i" }}){% else %}Yes{% endif %}
                                        {% else %}
                                            No
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if not forloop.last %}<hr class="my-6 border-gray-200">{% endif %}
            {% endfor %}

            <!-- Total Footer -->
            <div class="mt-6 pt-4 border-t-2 border-gray-300">
                <div class="flex justify-end items-center">
                    <span class="text-base font-semibold text-gray-700 mr-4">Total Guests:</span>
                    <span class="text-xl font-bold text-blue-600">{{ group.total_guests }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No guests</h3>
            <p class="mt-1 text-sm text-gray-500">No bookings have been assigned to this group yet.</p>
            <div class="mt-6">
                <a href="{% url 'group_update' group.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Add Bookings
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pickupTimeInputs = document.querySelectorAll('.pickup-time-input');
    const sendGroupBtn = document.getElementById('sendGroupBtn');
    const sendPickupTimesBtn = document.getElementById('sendPickupTimesBtn');
    const sendGroupForm = document.getElementById('sendGroupForm');
    const groupStatus = '{{ group.status }}';
    
    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to save pickup time
    async function savePickupTime(pickupPointId, pickupTime, inputElement) {
        try {
            const response = await fetch("{% url 'set_pickup_time' group.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    pickup_point_id: pickupPointId,
                    pickup_time: pickupTime
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update status icon
                const statusIcon = inputElement.parentElement.querySelector('.time-status-icon');
                if (pickupTime) {
                    statusIcon.innerHTML = `
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    `;
                } else {
                    statusIcon.innerHTML = `
                        <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    `;
                }
                
                // Update Send pickup times button (enabled when all times set)
                if (data.all_times_set) {
                    sendPickupTimesBtn.disabled = false;
                    sendPickupTimesBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    sendPickupTimesBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
                } else {
                    sendPickupTimesBtn.disabled = true;
                    sendPickupTimesBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    sendPickupTimesBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
                }
                // Update Send Group List button (enabled when all times set and group not yet sent)
                if (data.all_times_set && groupStatus === 'not_sent') {
                    sendGroupBtn.disabled = false;
                    sendGroupBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    sendGroupBtn.classList.add('bg-orange-600', 'hover:bg-orange-700', 'focus:ring-orange-500');
                } else {
                    sendGroupBtn.disabled = true;
                    sendGroupBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    sendGroupBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700', 'focus:ring-orange-500');
                }
                
                // Show brief success feedback
                inputElement.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => {
                    inputElement.classList.remove('ring-2', 'ring-green-500');
                }, 1000);
            } else {
                alert('Error saving pickup time: ' + data.message);
                inputElement.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => {
                    inputElement.classList.remove('ring-2', 'ring-red-500');
                }, 2000);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving pickup time. Please try again.');
        }
    }
    
    // Add change event listeners to all time inputs
    pickupTimeInputs.forEach(input => {
        input.addEventListener('change', function() {
            const pickupPointId = this.dataset.pickupPointId;
            const pickupTime = this.value;
            savePickupTime(pickupPointId, pickupTime, this);
        });
    });
    
    // Add confirmation dialog for sending group
    if (sendGroupForm) {
        sendGroupForm.addEventListener('submit', function(e) {
            if (groupStatus !== 'sent') {
                e.preventDefault();
                
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'This will send the group list to the transportation company, mark the availability date as inactive, and mark this group as sent. You can still edit pickup times after sending.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, send it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        sendGroupForm.submit();
                    }
                });
            }
        });
    }
});
</script>

{% endblock %}
