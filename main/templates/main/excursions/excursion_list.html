{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-header-grey">Excursions</h1>
        {% if user.is_staff %}
        <a href="{% url 'excursion_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            Add New Excursion
        </a>
        {% endif %}
    </div>

    <!-- Display Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success mb-4">
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Search and Filter Section -->
    <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
        <form method="GET" id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
            <!-- Search Input -->
            <div class="lg:col-span-2">
                <div class="relative">
                    <input 
                        type="text" 
                        name="search" 
                        value="{{ search_query }}" 
                        placeholder="Search excursions..." 
                        class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        hx-get="{% url 'excursion_list' %}"
                        hx-target="#excursion-list-container"
                        hx-trigger="keyup changed delay:500ms"
                        hx-include="#filter-form"
                    />
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Category Filter -->
            <div>
                <select 
                    name="category" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    hx-get="{% url 'excursion_list' %}"
                    hx-target="#excursion-list-container"
                    hx-trigger="change"
                    hx-include="#filter-form"
                >
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id|stringformat:"s" == category_query %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Tag Filter -->
            <div>
                <select 
                    name="tag" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    hx-get="{% url 'excursion_list' %}"
                    hx-target="#excursion-list-container"
                    hx-trigger="change"
                    hx-include="#filter-form"
                >
                    <option value="">All Tags</option>
                    {% for tag in tags %}
                        <option value="{{ tag.id }}" {% if tag.id|stringformat:"s" == tag_query %}selected{% endif %}>
                            {{ tag.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Date From Filter -->
            <div>
                <input 
                    type="date" 
                    name="date_from" 
                    value="{{ date_from_query }}" 
                    placeholder="From Date"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    hx-get="{% url 'excursion_list' %}"
                    hx-target="#excursion-list-container"
                    hx-trigger="change"
                    hx-include="#filter-form"
                />
            </div>
            
            <!-- Date To Filter -->
            <div>
                <input 
                    type="date" 
                    name="date_to" 
                    value="{{ date_to_query }}" 
                    placeholder="To Date"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    hx-get="{% url 'excursion_list' %}"
                    hx-target="#excursion-list-container"
                    hx-trigger="change"
                    hx-include="#filter-form"
                />
            </div>
            
            <!-- Clear Filters Button -->
            <div class="sm:col-span-2 lg:col-span-6">
                <button 
                    type="button"
                    id="clear-filters-btn"
                    onclick="clearAllFilters();"
                    class="w-full sm:w-auto px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    {% if not search_query and not category_query and not tag_query and not date_from_query and not date_to_query %}disabled{% endif %}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Clear Filters
                </button>
            </div>
        </form>
    </div>


    <div id="excursion-list-container">
        {% include 'main/excursions/partials/_excursion_list_content.html' %}
    </div>
    
</div>

<script>
    function updateClearFiltersButtonState() {
        const searchInput = document.querySelector('input[name="search"]');
        const categorySelect = document.querySelector('select[name="category"]');
        const tagSelect = document.querySelector('select[name="tag"]');
        const dateFromInput = document.querySelector('input[name="date_from"]');
        const dateToInput = document.querySelector('input[name="date_to"]');
        const clearButton = document.getElementById('clear-filters-btn');

        if (!clearButton) return;

        const hasSearch = searchInput && searchInput.value.trim() !== '';
        const hasCategory = categorySelect && categorySelect.value !== '';
        const hasTag = tagSelect && tagSelect.value !== '';
        const hasDateFrom = dateFromInput && dateFromInput.value !== '';
        const hasDateTo = dateToInput && dateToInput.value !== '';

        const hasAnyFilter = hasSearch || hasCategory || hasTag || hasDateFrom || hasDateTo;

        clearButton.disabled = !hasAnyFilter;
    }

    function clearAllFilters() {
        // Clear all form inputs
        const searchInput = document.querySelector('input[name="search"]');
        const categorySelect = document.querySelector('select[name="category"]');
        const tagSelect = document.querySelector('select[name="tag"]');
        const dateFromInput = document.querySelector('input[name="date_from"]');
        const dateToInput = document.querySelector('input[name="date_to"]');

        if (searchInput) searchInput.value = '';
        if (categorySelect) categorySelect.value = '';
        if (tagSelect) tagSelect.value = '';
        if (dateFromInput) dateFromInput.value = '';
        if (dateToInput) dateToInput.value = '';

        updateClearFiltersButtonState();
        
        // Fetch and update the list without filters
        fetch('{% url "excursion_list" %}', {
            headers: {
                'HX-Request': 'true'
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('excursion-list-container').innerHTML = html;
        })
        .catch(error => {
            console.error('Error clearing filters:', error);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('input[name="search"]');
        const categorySelect = document.querySelector('select[name="category"]');
        const tagSelect = document.querySelector('select[name="tag"]');
        const dateFromInput = document.querySelector('input[name="date_from"]');
        const dateToInput = document.querySelector('input[name="date_to"]');

        if (searchInput) {
            searchInput.addEventListener('input', updateClearFiltersButtonState);
            searchInput.addEventListener('change', updateClearFiltersButtonState);
        }
        if (categorySelect) categorySelect.addEventListener('change', updateClearFiltersButtonState);
        if (tagSelect) tagSelect.addEventListener('change', updateClearFiltersButtonState);
        if (dateFromInput) dateFromInput.addEventListener('change', updateClearFiltersButtonState);
        if (dateToInput) dateToInput.addEventListener('change', updateClearFiltersButtonState);

        // Initial state on page load
        updateClearFiltersButtonState();
    });
</script>

{% endblock %}


