{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
<style>
    #date-picker-inline {
        min-height: 250px;        
        position: relative;      
        border: 1px solid #ccc;  
        padding: 10px;
    }
    .pika-single {
        position: absolute;
        z-index: 9999;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Back button and actions -->
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'excursion_list' %}" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Excursions
        </a>
        {% if user.is_staff %}
        <div class="flex space-x-4">
            <a href="{% url 'availability_create' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Availability
            </a>
            {% if excursion.availabilities.exists %}
            <a href="{% url 'availability_detail' excursion.availabilities.first.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                View Availability
            </a>
            {% endif %}
            <a href="{% url 'excursion_update' excursion.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <button type="button" id="delete-excursion-btn" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Main content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left column - Main content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Hero section -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="relative">
                    <img src="{% if excursion.intro_image %}{{ excursion.intro_image.url }}{% else %}{% static 'main/images/excursion-default.jpg' %}{% endif %}" alt="{{ excursion.title }}" class="w-full h-96 object-cover">
                    <div class="absolute top-4 right-4">
                        {% if excursion.guide %}
                        <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                            Guided Excursion
                        {% endif %}
                        </span>
                    </div>
                </div>
                <div class="p-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4 excursion-title">{{ excursion.title }}</h1>
                    
                    <!-- Categories and Tags -->
                    <div class="flex flex-wrap mb-4">
                        <svg class="w-6 h-6 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-gray-600">{{ excursion_availability.start_time|time:"H:i" }} - {{ excursion_availability.end_time|time:"H:i" }}</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        {% for category in excursion.category.all %}
                            <span class="px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                                {{ category.name }}
                            </span>
                        {% endfor %}
                        {% for tag in excursion.tags.all %}
                            <span class="px-3 py-1 text-sm font-medium bg-gray-100 text-gray-800 rounded-full">
                                {{ tag.name }}
                            </span>
                        {% endfor %}
                    </div>

                    <!-- Description -->
                    <div class="prose max-w-none mb-6">
                        {{ excursion.description|safe }}
                    </div>

                    <div class="prose max-w-none mb-6 border-t border-gray-200 pt-4">
                        <p class="text-sm text-gray-500 mb-4">*Note: Pickup points and prices are based on the pickup group you have selected. <span class="text-sm text-gray-500 font-normal">(Selected Pickup Group: <span class="pickup-region font-semibold">{{ excursion_availability.pickup_groups.all.first.name }}</span>)</span></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-gray-900">Pickup Points</h2>
                                <div class="flex gap-6">
                                    {% for availability in excursion_availabilities %}
                                        {% for pick_group in availability.pickup_groups.all %}
                                            <div class="flex flex-col gap-2 group-{{ pick_group.id }} pickup-group">
                                                <h2 class="text-lg font-semibold text-gray-900 mt-2">{{ pick_group.name }}</h2>
                                                <ul class="pickup-points-list">
                                                    {% for pickup_point in pick_group.pickup_points.all %}
                                                    <li>
                                                        <div class="flex items-center py-2">
                                                            <svg width="16" height="16" fill="#3B82F6" viewBox="0 0 16 16">
                                                                <path d="M8 0C5.243 0 3 2.243 3 5c0 3.25 4.5 10.5 4.5 10.5s4.5-7.25 4.5-10.5c0-2.757-2.243-5-5-5zm0 7.5A2.5 2.5 0 1 1 8 2.5a2.5 2.5 0 0 1 0 5z"/>
                                                            </svg>
                                                            <a href="{% if pickup_point.google_maps_link %}{{ pickup_point.google_maps_link }}{% else %}#{% endif %}">{{ pickup_point.name }}</a>
                                                        </div>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-gray-900">Price Details</h2>
                                    <div class="space-y-2 mt-4 w-60">
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Adult</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="adult-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Child</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="child-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Infant</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="infant-price">0.00</span></span>
                                        </div>
                                    </div>
                                    
                            </div>

                        </div>
                        
                        
                    </div>
                </div>
            </div>

            <!-- Gallery -->
            {% if excursion.images.exists %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Gallery</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for image in excursion.images.all %}
                    <div class="relative aspect-w-4 aspect-h-3">
                        <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="object-cover rounded-lg">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Feedback Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Reviews</h2>
                    {% if excursion.overall_rating %}
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="ml-1 text-lg font-medium text-gray-900">{{ excursion.overall_rating|floatformat:1 }}</span>
                        <span class="ml-1 text-sm text-gray-500">({{ excursion.feedbacks.count }} reviews)</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Feedback Form -->
                {% if user.is_authenticated %}
                <form method="post" class="mb-8">
                    {% csrf_token %}
                    <input type="hidden" name="feedback_submit" value="1">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rating</label>
                            <div class="mt-1">
                                {{ feedback_form.rating }}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Your Review</label>
                            <div class="mt-1">
                                {{ feedback_form.comment }}
                            </div>
                        </div>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Submit Review
                        </button>
                    </div>
                </form>
                {% endif %}

                <!-- Feedback List -->
                <div class="space-y-6">
                    {% for feedback in excursion.feedback_entries.all %}
                    <div class="border-b border-gray-200 pb-6 last:border-0 last:pb-0">
                        <div class="flex items-center mb-2">
                            <div class="flex items-center">
                                {% for i in "12345"|make_list %}
                                <svg class="w-4 h-4 {% if forloop.counter <= feedback.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                {% endfor %}
                            </div>
                            <span class="ml-2 text-sm text-gray-500">{{ feedback.created_at|date:"F j, Y" }}</span>
                        </div>
                        <p class="text-gray-700">{{ feedback.comment }}</p>
                        <p class="text-sm text-gray-500 mt-1">By {{ feedback.author.username }}</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-4">No reviews yet. Be the first to review this excursion!</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right column - Booking section -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Book This Excursion</h2>
                {% if not excursion.availabilities.exists %}
                    <p class="text-gray-500 text-center py-4 not-availability">The excursion is currently not available.</p>
                {% else %}
                
                <!-- Availability selection -->
                <form method="post" class="space-y-4" id="booking-form">
                    {% csrf_token %}
                    <input type="hidden" name="booking_submit" value="1">
                    {% for availability in excursion_availabilities.all %}
                        <input type="hidden" name="{{ availability.id }}-adult-price" value="{{ availability.adult_price }}">
                        <input type="hidden" name="{{ availability.id }}-child-price" value="{{ availability.child_price }}">
                        <input type="hidden" name="{{ availability.id }}-infant-price" value="{{ availability.infant_price }}">
                        {% for pickup_group in availability.pickup_groups.all %}
                            <input type="hidden" name="{{ pickup_group.id }}-pickup-group" value="{{ pickup_group.name }}" data-availability-id="{{ availability.id }}">
                        {% endfor %}
                    {% endfor %}
                    <input type="hidden" name="availability_id" id="availability-id" value="">
                    <div class="flex flex-col gap-2 pickup-group-div" >
                        <label class="block text-md font-medium text-gray-700">Pickup Group</label>
                        <select name="pickup_group" id="pickup-group" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.pickup_group.errors %}border-red-500{% endif %}">
                            {% for group_id, group_name in pickup_group_map.items %}
                                <option value="{{ group_id }}">{{ group_name }}</option>
                            {% endfor %}
                        </select>
                        {% if form.pickup_group.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.pickup_group.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    {{ availability_dates_by_region|json_script:"available-dates-json" }}
                    {{ pickup_points|json_script:"pickup-points-json" }}

                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-medium text-gray-700">Pickup Point</label>
                        <select name="pickup_point" id="pickup-point" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.pickup_point.errors %}border-red-500{% endif %}">
                            <option value="">Select a pickup point</option>
                            {% for pickup_point in pickup_points %}
                                <option data-pickup_group="{{ pickup_point.pickup_group }}" value="{{ pickup_point.id }}">{{ pickup_point.name }}</option>
                            {% endfor %}
                        </select>
                        {% if form.pickup_point.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.pickup_point.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-md font-medium text-gray-700">Date</label>
                        <input type="text" id="date-picker" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 {% if form.date.errors %}border-red-500{% endif %}" placeholder="Select a date">
                        <!-- <span id="remaining-seats" class="text-sm text-gray-500">Remaining seats: <span id="remaining-seats-count">{{ remaining_seats }}</span></span> -->
                        
                        {% if form.date.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.date.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-3 gap-4 py-4">
                        <div>
                            <label class="block text-md font-medium text-gray-700">Adults</label>
                            <input type="number" name="adults" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.adults.errors %}border-red-500{% endif %}">
                            {% if form.adults.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.adults.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-medium text-gray-700">Children</label>
                            <input type="number" name="children" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.children.errors %}border-red-500{% endif %}">
                            {% if form.children.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.children.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-medium text-gray-700">Infants</label>
                            <input type="number" name="infants" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.infants.errors %}border-red-500{% endif %}">
                            {% if form.infants.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.infants.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                    </div>
                    {% comment %} {% if user.is_staff or user.userprofile.role == 'representative' %} {% endcomment %}
                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-medium text-gray-700">Guest Name</label>
                        <input type="text" name="guest_name" id="guest-name" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.guest_name.errors %}border-red-500{% endif %}" value="{% if return_data.client_name is not None %}{{ return_data.client_name }}{% endif %}">
                        {% if form.guest_name.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.guest_name.errors.0 }}</p>
                        {% endif %}

                        <label class="block text-md font-medium text-gray-700">Guest Email</label>
                        <input type="email" name="guest_email" id="guest-email" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.guest_email.errors %}border-red-500{% endif %}">
                        <span  id="guest-email-disabled" class="hidden text-sm text-gray-500">Your email is automatically filled in based on your profile. You cannot change it.</span>
                        {% if form.guest_email.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.guest_email.errors.0 }}</p>
                        {% endif %}

                    {% comment %} {% endif %} {% endcomment %}

                        <div class="mt-2">
                            <a href="#" id="clear-numbers" class="inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Clear</a>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="text-base font-semibold text-gray-900">Total</span>
                            <span class="text-lg font-bold text-blue-600">€<span id="total-price">0.00</span></span>
                            <input type="number" id="total-price-input" name="total_price" min="0" value="0" class="hidden">
                        </div>
                    </div>
                    
                    <div id="form-errors" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <ul class="list-disc list-inside text-sm text-red-600"></ul>
                    </div>

                    {% if user.is_staff or user.profile.role == 'representative' %}
                    <div class="flex flex-col gap-2">   
                        <label class="block text-md font-medium text-gray-700">Partial Payment</label>
                        <input type="number" name="partial_payment" id="partial-payment" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <div class="hidden remaining-price-div">
                            <span class="text-sm font-medium text-gray-600">Remaining</span>
                            <span class="text-base font-semibold text-gray-900">€<span id="remaining-price">0.00</span>
                        </div>
                        <div class="flex flex-col gap-2 hidden" id="partial-paid-method-div">
                            <label class="block text-md font-medium text-gray-700">Payment Method</label>
                            <select name="partial_paid_method" id="partial-paid-method" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.partial_paid_method.errors %}border-red-500{% endif %}">
                                <option value="" selected>Select a payment method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                            </select>
                        </div>
                        
                        <div class="reservation-id-div">
                            <label class="block text-md font-medium text-gray-700">Reservation ID</label>
                            <input type="text" name="voucher_code" id="voucher_code" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        </div>
                    </div>
                    {% endif %}

                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:cursor-pointer hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg id="loading-spinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="submit-text">Book Now</span>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<form id="delete-ex-form" action="{% url 'excursion_delete' excursion.pk %}" method="post" class="hidden">
    {% csrf_token %}
</form>

{% block extra_js %}
<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const availableDatesByRegion = JSON.parse(document.getElementById('available-dates-json').textContent);
    const pickupPointsByGroup = JSON.parse(document.getElementById('pickup-points-json').textContent);

    const pickupGroupSelect = document.getElementById('pickup-group');
    const pickupPointSelect = document.getElementById('pickup-point');
    const datePickerInput = document.getElementById('date-picker');
    
    const userRole = getCookie('user_role');
    const userId = getCookie('user_id');
    // const availabilityIdInput = document.getElementById('availability-id');

    // console.log(availabilityIdInput);

    let picker = null;

    // Helper: update pickup points dropdown for selected group
    function updatePickupPoints(groupId) {
        const groupObj = pickupPointsByGroup.find(g => g.pickup_group == groupId);
        pickupPointSelect.innerHTML = '<option value="">Select a pickup point</option>';
        if (groupObj) {
            groupObj.points.forEach(point => {
                const option = document.createElement('option');
                option.value = point.id;
                option.textContent = point.name;
                pickupPointSelect.appendChild(option);
            });
        }else{
            console.log('no group found');
        }
    }

    // Helper: update date picker for selected group
    function updateDatePicker(groupId) {
        const availableDates = availableDatesByRegion[groupId] || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Set to start of today
        
        // Filter out past dates
        const futureAvailableDates = availableDates.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= today;
        });
        
        if (picker) picker.destroy();
        picker = flatpickr(datePickerInput, {
            enable: futureAvailableDates.map(item => item.date),
            dateFormat: "Y-m-d",
            position: "below",
            onChange: function(selectedDates, dateStr) {
                const selectedDate = futureAvailableDates.find(item => item.date === dateStr);
                // availabilityIdInput.value = selectedDate ? selectedDate.id : '';
            }
        });
        datePickerInput.value = '';
        // availabilityIdInput.value = '';
    }

    // On pickup group change, update both date picker and pickup points
    pickupGroupSelect.addEventListener('change', function() {
        const groupId = this.value;
        updateDatePicker(groupId);
        updatePickupPoints(groupId);
    });


    document.addEventListener('DOMContentLoaded', function() {

        const initialGroupId = pickupGroupSelect.value;
        updateDatePicker(initialGroupId);
        updatePickupPoints(initialGroupId);

        const notAvailability = document.querySelector('.not-availability');
        const bookingForm = document.getElementById('booking-form');
        const formErrors = document.getElementById('form-errors');
        const voucherCode = getCookie('voucher_code');
        
        // console.log('voucherCode: ' + voucherCode);
        
        if (!notAvailability) {
            let picker = null;

            if (userRole == 'client') {
                console.log('userRole: ' + userRole);
                console.log('userId: ' + userId);
                fetch('/get_user_details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                    // body: JSON.stringify({
                    //     user_id: userId
                    // })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('User profile data:', data.user_profile);
                    document.querySelector('#guest-name').value = data.user_profile.name;
                    document.querySelector('#guest-email').value = data.user_profile.email;
                    document.querySelector('#guest-email').disabled = true;
                    document.querySelector('#guest-email-disabled').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            

            function checkVoucher() {
                const voucherInput = getCookie('voucher_code');
                // console.log('voucherInput: ' + voucherInput);
                if (voucherInput) {
                    fetch('/check_voucher/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            voucher_code: voucherInput
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // console.log('data.return_data: ' + data.return_data);
                            // console.log('data.message: ' + data.message);
                            // console.log('data.success: ' + data.success);
                            
                            document.querySelector('#guest-name').value = data.return_data.client_name;
                            document.querySelector('#guest-email').value = data.return_data.client_email;
                            document.querySelector('.pickup-group').classList.add('hidden');
                            document.querySelector('.group-' + data.return_data.pickup_group_id).classList.remove('hidden');

                            if (data.return_data.pickup_group_id && data.return_data.pickup_point_id) {
                                document.querySelector('select[name="pickup_group"]').value = data.return_data.pickup_group_id;
                                updateDatePicker(data.return_data.pickup_group_id);
                                updatePickupPoints(data.return_data.pickup_group_id);
                                document.querySelector('#pickup-point').value = data.return_data.pickup_point_id;
                                document.querySelector('.pickup-group').classList.add('hidden');
                                document.querySelector('.group-' + data.return_data.pickup_group_id).classList.remove('hidden');
                            } 

                        } else {
                            console.log('data.message: ' + data.message);
                            console.log('data.success: ' + data.success);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            
            }
            checkVoucher();

            function initializeDatePicker(pickupGroupId) {
                const availableDates = availableDatesByRegion[pickupGroupId] || [];
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to start of today
                
                // Filter out past dates
                const futureAvailableDates = availableDates.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= today;
                });

                // Clear existing picker if it exists
                if (picker) {
                    picker.destroy();
                }

                // Initialize new picker
                picker = flatpickr("#date-picker", {
                    enable: futureAvailableDates.map(item => item.date),
                    dateFormat: "Y-m-d",
                    position: "below",
                    onChange: function(selectedDates, dateStr) {
                        const selectedDate = futureAvailableDates.find(item => item.date === dateStr);
                        if (selectedDate) {
                            document.getElementById("availability-id").value = selectedDate.id;
                        } else {
                            document.getElementById("availability-id").value = '';
                        }
                    },
                });

                // Clear any previously selected date
                document.getElementById("availability-id").value = '';
                document.getElementById("date-picker").value = '';
            }

            // Initialize date picker for the initially selected region
            const initialPickupGroup = document.querySelector('select[name="pickup_group"]').value;
            initializeDatePicker(initialPickupGroup);

            // Update date picker when pickup group changes
            document.querySelector('select[name="pickup_group"]').addEventListener('change', function(e) {
                initializeDatePicker(e.target.value);
                updatePriceAndPickupPoints();

            });

            function calculateTotal() {
                const pickupGroup = document.querySelector('select[name="pickup_group"]').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                const availabilityId = document.querySelector(`input[name="${pickupGroup}-pickup-group"]`).dataset.availabilityId;

                // console.log('calculateTotal availabilityId: ' + availabilityId);
                // console.log(availabilityId);

                const adultPrice = document.querySelector(`input[name="${availabilityId}-adult-price"]`).value;
                const childPrice = document.querySelector(`input[name="${availabilityId}-child-price"]`).value;
                const infantPrice = document.querySelector(`input[name="${availabilityId}-infant-price"]`).value;
                
                const total = (adults * adultPrice) + (children * childPrice) + (infants * infantPrice);
                document.getElementById('total-price').textContent = total.toFixed(2);
                document.getElementById('total-price-input').value = total;
            }

            // Calculate initial total
            calculateTotal();

            function updatePriceAndPickupPoints() {
                const pickupGroupId = document.querySelector('select[name="pickup_group"]').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                const availabilityId = document.querySelector(`input[name="${pickupGroupId}-pickup-group"]`).dataset.availabilityId;

                // console.log('updatePriceAndPickupPoints availabilityId: ' + availabilityId);

                const pickupGroupName = document.querySelector(`input[name="${pickupGroupId}-pickup-group"]`).value;
                // console.log(pickupGroupName);
                document.querySelector('.pickup-region').textContent = pickupGroupName;
                document.querySelectorAll('.pickup-group').forEach(group => {
                    group.classList.add('hidden');
                });
                const pickupGroup = document.querySelectorAll('.group-' + pickupGroupId).forEach(group => {
                    group.classList.remove('hidden');
                });

                document.querySelectorAll('.pickup-point').forEach(point => {
                    point.classList.add('hidden');
                });

                const pickupPoints_options = document.querySelectorAll('select[name="pickup_point"] option');
                
                // pickupPoints_options.forEach(point => {
                //     point.classList.add('hidden');
                //     if (point.dataset.pickup_group === pickupGroupId) {
                //         point.classList.remove('hidden');
                //     }
                // });

                // Select the first available pickup point for the selected region
                const pickupPointSelect = document.getElementById('pickup-point');
                const availableOptions = Array.from(pickupPoints_options).filter(option => 
                    option.dataset.pickup_group === pickupGroupId && option.value !== ''
                );
                
                if (availableOptions.length > 0) {
                    pickupPointSelect.value = availableOptions[0].value;
                } else {
                    pickupPointSelect.value = '';
                }

                const adultPrice = document.querySelector(`input[name="${availabilityId}-adult-price"]`).value;
                const childPrice = document.querySelector(`input[name="${availabilityId}-child-price"]`).value;
                const infantPrice = document.querySelector(`input[name="${availabilityId}-infant-price"]`).value;

                document.getElementById('adult-price').textContent = adultPrice;
                document.getElementById('child-price').textContent = childPrice;
                document.getElementById('infant-price').textContent = infantPrice;

                const total = (adults * adultPrice) + (children * childPrice) + (infants * infantPrice);
                document.getElementById('total-price').textContent = total.toFixed(2);
                document.getElementById('total-price-input').value = total;

                calculateTotal();
            }

            // Add event listeners to number inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', calculateTotal);
                input.addEventListener('input', calculateTotal);    
            });

            document.querySelector('select[name="pickup_group"]').addEventListener('change', updatePriceAndPickupPoints);

            updatePriceAndPickupPoints();

            document.querySelector('#clear-numbers').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = 0;
                });
                calculateTotal();
                document.querySelector('#remaining-price').textContent = document.querySelector('#total-price').textContent;
                document.querySelector('#total-price-input').value = document.querySelector('#total-price').textContent;
                updatePriceAndPickupPoints();
            });
        
            // partialPayment = document.querySelector('#partial-payment').value;
            if (userRole == 'admin') {
                document.querySelector('#partial-payment').addEventListener('change', function(e) {
                    e.preventDefault();
                    const partialPayment = document.querySelector('#partial-payment').value;
                    // const partialPaidMethod = document.querySelector('#partial-paid-method').value;
                    const total = document.querySelector('#total-price').textContent;

                    if (partialPayment <= 0) {
                        document.querySelector('.remaining-price-div').classList.add('hidden');
                        document.querySelector('#partial-paid-method-div').classList.add('hidden');
                        return;
                    } else {
                        const remaining = total - partialPayment;
                        document.querySelector('.remaining-price-div').classList.remove('hidden');
                        document.querySelector('#remaining-price').textContent = remaining.toFixed(2);
                        document.querySelector('#partial-paid-method-div').classList.remove('hidden');
                        // document.querySelector('#partial-paid-method').value = partialPaidMethod;
                    }
                });

                // Delete excursion confirmation
                document.getElementById('delete-excursion-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    const excursionTitle = document.querySelector('.excursion-title').textContent;
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Do you want to delete excursion "${excursionTitle}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('delete-ex-form').submit();
                        }
                    });
                });
            }
            

            // Booking form submission
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get submit button and loading elements
                const submitButton = document.getElementById('submit-button');
                const loadingSpinner = document.getElementById('loading-spinner');
                const submitText = document.getElementById('submit-text');
                
                // Show loading state
                submitButton.disabled = true;
                loadingSpinner.classList.remove('hidden');
                submitText.textContent = 'Processing...';
                
                // Clear previous errors
                if (formErrors) {
                    formErrors.classList.add('hidden');
                    const errorList = formErrors.querySelector('ul');
                    if (errorList) {
                        errorList.innerHTML = '';
                    }
                }
                document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
                document.querySelectorAll('.text-red-600').forEach(el => el.remove());
                
                // Get form values
                const selectedDate = document.getElementById('date-picker').value;
                // const availabilityId = document.getElementById('availability-id').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                const pickupGroupId = document.querySelector('select[name="pickup_group"]').value;
                const availabilityId = document.querySelector(`input[name="${pickupGroupId}-pickup-group"]`).dataset.availabilityId;
                const guestEmail = document.querySelector('#guest-email').value;
                const guestName = document.querySelector('#guest-name').value;
                const voucherInput = document.querySelector('#voucher_code');
                const voucherCode = voucherInput && voucherInput.value ? voucherInput.value : "";
                const partialPaymentInput = document.querySelector('#partial-payment');
                const partialPayment = partialPaymentInput && partialPaymentInput.value ? partialPaymentInput.value : "";
                const partialPaidMethodInput = document.querySelector('#partial-paid-method');
                const partialPaidMethod = partialPaidMethodInput && partialPaidMethodInput.value ? partialPaidMethodInput.value : '';
                // Validate form
                let errors = [];

                if (!selectedDate || !availabilityId) {
                    errors.push({ field: 'date', message: 'Please select a date.' });
                    const datePicker = document.getElementById('date-picker');
                    if (datePicker) {
                        datePicker.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select a date.';
                        datePicker.parentNode.appendChild(errorDiv);
                    }
                }

                if (adults + children + infants === 0) {
                    errors.push({ field: 'participants', message: 'Please select at least one participant (adult, child, or infant).' });
                    ['adults', 'children', 'infants'].forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                        }
                    });
                    const adultsInput = document.querySelector('input[name="adults"]');
                    if (adultsInput) {
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select at least one participant.';
                        adultsInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (!guestName) {
                    errors.push({ field: 'guest-name', message: 'Please enter your name.' });
                    const guestNameInput = document.querySelector('#guest-name');
                    if (guestNameInput) {
                        guestNameInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please enter your name.';
                        guestNameInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (!guestEmail) {
                    errors.push({ field: 'guest-email', message: 'Please enter your email.' });
                    const guestEmailInput = document.querySelector('#guest-email');
                    if (guestEmailInput) {
                        guestEmailInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please enter your email.';
                        guestEmailInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (userRole == 'admin') {
                    
                    if (partialPayment && partialPayment > 0 && !partialPaidMethod) {
                        errors.push({ field: 'partial-paid-method', message: 'Please select a payment method.' });
                        const partialPaidMethodInput = document.querySelector('#partial-paid-method');
                        if (partialPaidMethodInput) {
                            partialPaidMethodInput.classList.add('border-red-500');
                            const errorDiv = document.createElement('p');
                            errorDiv.className = 'mt-1 text-sm text-red-600';
                            errorDiv.textContent = 'Please select a payment method.';
                                partialPaidMethodInput.parentNode.appendChild(errorDiv);
                            }
                    }
                }

                if (errors.length > 0) {
                    // Hide loading state if validation fails
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    submitText.textContent = 'Book Now';
                    return;
                }

                // If validation passes, submit the form
                const formData = new FormData(bookingForm);
                formData.append('selected_date', selectedDate);
                formData.append('availability_id', availabilityId);
                formData.append('voucher_code', voucherCode ? voucherCode : "");
                formData.append('partial_payment', partialPayment ? partialPayment : "");
                formData.append('partial_paid_method', partialPaidMethod ? partialPaidMethod : "");
                // Submit form via AJAX
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    // console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);

                    if (data.success) {
                        console.log('Redirecting to:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        // Hide loading state
                        submitButton.disabled = false;
                        loadingSpinner.classList.add('hidden');
                        submitText.textContent = 'Book Now';
                        document.getElementById('form-errors').textContent = data.message;
                        console.log('data.message:', data.message);
                        // Display server-side validation errors
                        if (data.errors) {
                            console.log('Validation errors:', data.errors);
                            console.log('Error message:', data.message);
                            Object.keys(data.errors).forEach(field => {
                                const input = document.querySelector(`[name="${field}"]`);
                                if (input) {
                                    input.classList.add('border-red-500');
                                    const errorDiv = document.createElement('p');
                                    errorDiv.className = 'mt-1 text-sm text-red-600';
                                    errorDiv.textContent = data.errors[field][0];
                                    // errorDiv.textContent = data.errors;
                                    input.parentNode.appendChild(errorDiv);
                                }
                            });
                        } else if (data.message) {
                            // console.log('Error message:', data.message);
                            if (formErrors) {
                                formErrors.classList.remove('hidden');
                                const errorList = formErrors.querySelector('ul');
                                if (errorList) {
                                    const errorItem = document.createElement('li');
                                    errorItem.textContent = data.message;
                                    errorList.appendChild(errorItem);
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Hide loading state
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    submitText.textContent = 'Book Now';
                    
                    if (formErrors) {
                        formErrors.classList.remove('hidden');
                        const errorList = formErrors.querySelector('ul');
                        if (errorList) {
                            const errorItem = document.createElement('li');
                            errorItem.textContent = 'An error occurred while processing your booking.';
                            errorList.appendChild(errorItem);
                        }
                    }
                    document.getElementById('form-errors').textContent = data.message;
                    console.log('data.message:', data.message);
                });
            });
        }
    });
</script>
{% endblock %}
{% endblock %}
