{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
<style>
    #date-picker-inline {
        min-height: 250px;        
        position: relative;      
        border: 1px solid #ccc;  
        padding: 10px;
    }
    .pika-single {
        position: absolute;
        z-index: 9999;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Back button and actions -->
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'excursion_list' %}" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Excursions
        </a>
        {% if user.is_staff %}
        <div class="flex space-x-4">
            <a href="{% url 'availability_create' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Availability
            </a>
            {% if excursion.availabilities.exists %}
            <a href="{% url 'availability_detail' excursion.availabilities.first.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                View Availability
            </a>
            {% endif %}
            <a href="{% url 'excursion_update' excursion.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <button type="button" id="delete-excursion-btn" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Main content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left column - Main content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Hero section -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="relative">
                    <img src="{{ excursion.intro_image.url }}" alt="{{ excursion.title }}" class="w-full h-96 object-cover">
                    <div class="absolute top-4 right-4">
                        {% if excursion.guide %}
                        <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                            Guided Excursion
                        {% endif %}
                        </span>
                    </div>
                </div>
                <div class="p-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4 excursion-title">{{ excursion.title }}</h1>
                    
                    <!-- Categories and Tags -->
                    <div class="flex flex-wrap mb-4">
                        <svg class="w-6 h-6 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-gray-600">{{ excursion_availability.start_time|time:"H:i" }} - {{ excursion_availability.end_time|time:"H:i" }}</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        {% for category in excursion.category.all %}
                            <span class="px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                                {{ category.name }}
                            </span>
                        {% endfor %}
                        {% for tag in excursion.tags.all %}
                            <span class="px-3 py-1 text-sm font-medium bg-gray-100 text-gray-800 rounded-full">
                                {{ tag.name }}
                            </span>
                        {% endfor %}
                    </div>

                    <!-- Description -->
                    <div class="prose max-w-none mb-6">
                        {{ excursion.description|safe }}
                    </div>

                    <div class="prose max-w-none mb-6 border-t border-gray-200 pt-4">
                        <p class="text-sm text-gray-500 mb-4">*Note: Pickup points and prices are based on the region you have selected. <span class="text-sm text-gray-500 font-normal">(Selected Region: <span class="pickup-region font-semibold">{{ excursion_availability.region.name }}</span>)</span></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-gray-900">Pickup Points</h2>
                                <div class="flex gap-6">
                                    {% for availability in excursion_availabilities %}
                                        {% for pick_group in availability.pickup_groups.all %}
                                            <div class="flex flex-col gap-2 group-{{ availability.region.id }} pickup-group">
                                                <h2 class="text-lg font-semibold text-gray-900 mt-2">{{ pick_group.name }}</h2>
                                                <ul class="pickup-points-list">
                                                    {% for pickup_point in pick_group.pickup_points.all|dictsortreversed:"priority" %}
                                                    <li>
                                                        <div class="flex items-center py-2">
                                                            <svg width="16" height="16" fill="#3B82F6" viewBox="0 0 16 16">
                                                                <path d="M8 0C5.243 0 3 2.243 3 5c0 3.25 4.5 10.5 4.5 10.5s4.5-7.25 4.5-10.5c0-2.757-2.243-5-5-5zm0 7.5A2.5 2.5 0 1 1 8 2.5a2.5 2.5 0 0 1 0 5z"/>
                                                            </svg>
                                                            <a href="{{ pickup_point.google_maps_link }}">{{ pickup_point.name }}</a>
                                                        </div>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-gray-900">Price Details</h2>
                                    <div class="space-y-2 mt-4 w-60">
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Price per adult</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="adult-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Price per child</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="child-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Price per infant</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="infant-price">0.00</span></span>
                                        </div>
                                    </div>
                                    
                            </div>

                        </div>
                        
                        
                    </div>
                </div>
            </div>

            <!-- Gallery -->
            {% if excursion.images.exists %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Gallery</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for image in excursion.images.all %}
                    <div class="relative aspect-w-4 aspect-h-3">
                        <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="object-cover rounded-lg">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Feedback Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Reviews</h2>
                    {% if excursion.overall_rating %}
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="ml-1 text-lg font-medium text-gray-900">{{ excursion.overall_rating|floatformat:1 }}</span>
                        <span class="ml-1 text-sm text-gray-500">({{ excursion.feedbacks.count }} reviews)</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Feedback Form -->
                {% if user.is_authenticated %}
                <form method="post" class="mb-8">
                    {% csrf_token %}
                    <input type="hidden" name="feedback_submit" value="1">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rating</label>
                            <div class="mt-1">
                                {{ feedback_form.rating }}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Your Review</label>
                            <div class="mt-1">
                                {{ feedback_form.comment }}
                            </div>
                        </div>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Submit Review
                        </button>
                    </div>
                </form>
                {% endif %}

                <!-- Feedback List -->
                <div class="space-y-6">
                    {% for feedback in excursion.feedback_entries.all %}
                    <div class="border-b border-gray-200 pb-6 last:border-0 last:pb-0">
                        <div class="flex items-center mb-2">
                            <div class="flex items-center">
                                {% for i in "12345"|make_list %}
                                <svg class="w-4 h-4 {% if forloop.counter <= feedback.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                {% endfor %}
                            </div>
                            <span class="ml-2 text-sm text-gray-500">{{ feedback.created_at|date:"F j, Y" }}</span>
                        </div>
                        <p class="text-gray-700">{{ feedback.comment }}</p>
                        <p class="text-sm text-gray-500 mt-1">By {{ feedback.author.username }}</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-4">No reviews yet. Be the first to review this excursion!</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right column - Booking section -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Book This Excursion</h2>
                {% if not excursion.availabilities.exists %}
                    <p class="text-gray-500 text-center py-4 not-availability">The excursion is currently not available.</p>
                {% else %}
                <!-- Availability selection -->
                <form method="post" class="space-y-4" id="booking-form">
                    {% csrf_token %}
                    <input type="hidden" name="booking_submit" value="1">
                    {% for availability in excursion_availabilities.all %}
                        <input type="hidden" name="{{ availability.region.id }}-adult-price" value="{{ availability.adult_price }}">
                        <input type="hidden" name="{{ availability.region.id }}-child-price" value="{{ availability.child_price }}">
                        <input type="hidden" name="{{ availability.region.id }}-infant-price" value="{{ availability.infant_price }}">
                        <input type="hidden" name="{{ availability.region.id }}-region" value="{{ availability.region.name }}">
                        <input type="hidden" name="{{ availability.region.id }}-available-capacity" value="{{ availability.weekdays.capacity }}">
                    {% endfor %}
                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-medium text-gray-700">Do you have a voucher?</label>
                        <input type="text" name="voucher" id="voucher" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter your voucher code">
                        <button type="button" id="submit-voucher-btn" class="mt-2 px-4 py-2 rounded bg-blue-600 text-white">Check Voucher</button>
                        <div id="voucher-message" class="mt-2 text-sm"></div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-medium text-gray-700">Select Region</label>
                        <select name="region" id="region" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.region.errors %}border-red-500{% endif %}">
                            {% for availability in excursion_availabilities.all %}
                                <option value="{{ availability.region.id }}">{{ availability.region.name }}</option>
                            {% endfor %}
                        </select>
                        {% if form.region.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.region.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-md font-medium text-gray-700">Select a Date</label>
                        <input type="text" id="date-picker" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 {% if form.date.errors %}border-red-500{% endif %}" placeholder="Select a date">
                        <input type="hidden" name="availability_id" id="availability-id">
                        {% if form.date.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.date.errors.0 }}</p>
                        {% endif %}
                    </div>
                    {{ availability_dates_by_region|json_script:"available-dates-json" }}

                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-medium text-gray-700">Select Pickup Point</label>
                        <select name="pickup_point" id="pickup-point" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.pickup_point.errors %}border-red-500{% endif %}">
                            <option value="">Select a pickup point</option>
                            {% for pickup_point in pickup_points %}
                                {% for point in pickup_point %}
                                    <option data-region="{{ point.pickup_group__region }}" value="{{ point.id }}">{{ point.name }}</option>
                                {% endfor %}
                            {% endfor %}
                        </select>
                        {% if form.pickup_point.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.pickup_point.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-3 gap-4 py-4">
                        <div>
                            <label class="block text-md font-medium text-gray-700">Adults</label>
                            <input type="number" name="adults" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.adults.errors %}border-red-500{% endif %}">
                            {% if form.adults.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.adults.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-medium text-gray-700">Children</label>
                            <input type="number" name="children" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.children.errors %}border-red-500{% endif %}">
                            {% if form.children.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.children.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-medium text-gray-700">Infants</label>
                            <input type="number" name="infants" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.infants.errors %}border-red-500{% endif %}">
                            {% if form.infants.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.infants.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div class="">
                            <a href="#" id="clear-numbers" class="px-3 py-1 shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Clear</a>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="text-base font-semibold text-gray-900">Total</span>
                            <span class="text-lg font-bold text-blue-600">€<span id="total-price">0.00</span></span>
                            <input type="number" id="total-price-input" name="total_price" min="0" value="0" class="hidden">
                        </div>
                    </div>
                    
                    <div id="form-errors" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <ul class="list-disc list-inside text-sm text-red-600"></ul>
                    </div>

                    {% if user.is_staff %}
                    <div class="flex flex-col gap-2">   
                        <label class="block text-md font-medium text-gray-700">Partial Payment</label>
                        <input type="number" name="partial_payment" id="partial-payment" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <div class="hidden remaining-price-div">
                            <span class="text-sm font-medium text-gray-600">Remaining</span>
                            <span class="text-base font-semibold text-gray-900">€<span id="remaining-price">0.00</span></div>
                    </div>
                    {% endif %}

                    <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Proceed with Booking
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<form id="delete-ex-form" action="{% url 'excursion_delete' excursion.pk %}" method="post" class="hidden">
    {% csrf_token %}
</form>

{% block extra_js %}
<script>

    //  get csrf token for ajax requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const availableDatesByRegion = JSON.parse(
        document.getElementById('available-dates-json').textContent
    );

    document.addEventListener('DOMContentLoaded', function() {
        const notAvailability = document.querySelector('.not-availability');
        const bookingForm = document.getElementById('booking-form');
        const formErrors = document.getElementById('form-errors');
        
        if (!notAvailability) {
            let picker = null;

            function initializeDatePicker(regionId) {
                const availableDates = availableDatesByRegion[regionId] || [];

                // Clear existing picker if it exists
                if (picker) {
                    picker.destroy();
                }

                // Initialize new picker
                picker = flatpickr("#date-picker", {
                    enable: availableDates.map(item => item.date),
                    dateFormat: "Y-m-d",
                    position: "below",
                    onChange: function(selectedDates, dateStr) {
                        const selectedDate = availableDates.find(item => item.date === dateStr);
                        if (selectedDate) {
                            document.getElementById("availability-id").value = selectedDate.id;
                        } else {
                            document.getElementById("availability-id").value = '';
                        }
                    },
                });

                // Clear any previously selected date
                document.getElementById("availability-id").value = '';
                document.getElementById("date-picker").value = '';
            }

            // Initialize date picker for the initially selected region
            const initialRegion = document.querySelector('select[name="region"]').value;
            initializeDatePicker(initialRegion);

            // Update date picker when region changes
            document.querySelector('select[name="region"]').addEventListener('change', function(e) {
                initializeDatePicker(e.target.value);
                updatePriceAndPickupPoints();
            });

            // Calculate total price based on number of guests
            function calculateTotal() {
                const region = document.querySelector('select[name="region"]').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                
                const adultPrice = document.querySelector(`input[name="${region}-adult-price"]`).value;
                const childPrice = document.querySelector(`input[name="${region}-child-price"]`).value;
                const infantPrice = document.querySelector(`input[name="${region}-infant-price"]`).value;
                
                const total = (adults * adultPrice) + (children * childPrice) + (infants * infantPrice);
                document.getElementById('total-price').textContent = total.toFixed(2);
                document.getElementById('total-price-input').value = total;
            }

            // Calculate initial total
            calculateTotal();

            function updatePriceAndPickupPoints() {
                const region = document.querySelector('select[name="region"]').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;

                const regionName = document.querySelector(`input[name="${region}-region"]`).value;
                document.querySelector('.pickup-region').textContent = regionName;
                document.querySelectorAll('.pickup-group').forEach(group => {
                    group.classList.add('hidden');
                });
                const pickupGroup = document.querySelectorAll('.group-' + region).forEach(group => {
                    group.classList.remove('hidden');
                });

                document.querySelectorAll('.pickup-point').forEach(point => {
                    point.classList.add('hidden');
                });

                const pickupPoints_options = document.querySelectorAll('select[name="pickup_point"] option');
                
                pickupPoints_options.forEach(point => {
                    point.classList.add('hidden');
                    if (point.dataset.region === region) {
                        point.classList.remove('hidden');
                    }
                });

                // Select the first available pickup point for the selected region
                const pickupPointSelect = document.getElementById('pickup-point');
                const availableOptions = Array.from(pickupPoints_options).filter(option => 
                    option.dataset.region === region && option.value !== ''
                );
                
                if (availableOptions.length > 0) {
                    pickupPointSelect.value = availableOptions[0].value;
                } else {
                    pickupPointSelect.value = '';
                }

                const adultPrice = document.querySelector(`input[name="${region}-adult-price"]`).value;
                const childPrice = document.querySelector(`input[name="${region}-child-price"]`).value;
                const infantPrice = document.querySelector(`input[name="${region}-infant-price"]`).value;

                document.getElementById('adult-price').textContent = adultPrice;
                document.getElementById('child-price').textContent = childPrice;
                document.getElementById('infant-price').textContent = infantPrice;

                const total = (adults * adultPrice) + (children * childPrice) + (infants * infantPrice);
                document.getElementById('total-price').textContent = total.toFixed(2);
                document.getElementById('total-price-input').value = total;
            }

            // Add event listeners to number inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', calculateTotal);
                input.addEventListener('input', calculateTotal);
            });

            document.querySelector('select[name="region"]').addEventListener('change', updatePriceAndPickupPoints);

            updatePriceAndPickupPoints();

            document.querySelector('#clear-numbers').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = 0;
                });
                calculateTotal();
                document.querySelector('#remaining-price').textContent = document.querySelector('#total-price').textContent;
                document.querySelector('#total-price-input').value = document.querySelector('#total-price').textContent;
                updatePriceAndPickupPoints();
            });
        
            document.querySelector('#partial-payment').addEventListener('change', function(e) {
                e.preventDefault();
                const partialPayment = document.querySelector('#partial-payment').value;
                const total = document.querySelector('#total-price').textContent;

                if (partialPayment <= 0) {
                    document.querySelector('.remaining-price-div').classList.add('hidden');
                    return;
                } else {
                    const remaining = total - partialPayment;
                    document.querySelector('.remaining-price-div').classList.remove('hidden');
                    document.querySelector('#remaining-price').textContent = remaining.toFixed(2);
                }
            });

            // Delete excursion confirmation
            document.getElementById('delete-excursion-btn').addEventListener('click', function(e) {
                e.preventDefault();
                const excursionTitle = document.querySelector('.excursion-title').textContent;
                Swal.fire({
                    title: 'Are you sure?',
                    text: `Do you want to delete excursion "${excursionTitle}"?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('delete-ex-form').submit();
                    }
                });
            });

            // Add form validation
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Clear previous errors
                if (formErrors) {
                    formErrors.classList.add('hidden');
                    const errorList = formErrors.querySelector('ul');
                    if (errorList) {
                        errorList.innerHTML = '';
                    }
                }
                document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
                document.querySelectorAll('.text-red-600').forEach(el => el.remove());
                
                // Get form values
                const selectedDate = document.getElementById('date-picker').value;
                const availabilityId = document.getElementById('availability-id').value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                const regionId = document.querySelector('select[name="region"]').value;

                // Validate form
                let errors = [];

                if (!selectedDate || !availabilityId) {
                    errors.push({ field: 'date', message: 'Please select a date.' });
                    const datePicker = document.getElementById('date-picker');
                    if (datePicker) {
                        datePicker.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select a date.';
                        datePicker.parentNode.appendChild(errorDiv);
                    }
                }

                if (adults + children + infants === 0) {
                    errors.push({ field: 'participants', message: 'Please select at least one participant (adult, child, or infant).' });
                    ['adults', 'children', 'infants'].forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                        }
                    });
                    const adultsInput = document.querySelector('input[name="adults"]');
                    if (adultsInput) {
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select at least one participant.';
                        adultsInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (errors.length > 0) {
                    return;
                }

                // If validation passes, submit the form
                const formData = new FormData(bookingForm);
                formData.append('selected_date', selectedDate);
                formData.append('availability_id', availabilityId);

                // Submit form via AJAX
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        console.log('Redirecting to:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        // Display server-side validation errors
                        if (data.errors) {
                            console.log('Validation errors:', data.errors);
                            Object.keys(data.errors).forEach(field => {
                                const input = document.querySelector(`[name="${field}"]`);
                                if (input) {
                                    input.classList.add('border-red-500');
                                    const errorDiv = document.createElement('p');
                                    errorDiv.className = 'mt-1 text-sm text-red-600';
                                    errorDiv.textContent = data.errors[field][0];
                                    input.parentNode.appendChild(errorDiv);
                                }
                            });
                        } else if (data.message) {
                            console.log('Error message:', data.message);
                            if (formErrors) {
                                formErrors.classList.remove('hidden');
                                const errorList = formErrors.querySelector('ul');
                                if (errorList) {
                                    const errorItem = document.createElement('li');
                                    errorItem.textContent = data.message;
                                    errorList.appendChild(errorItem);
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (formErrors) {
                        formErrors.classList.remove('hidden');
                        const errorList = formErrors.querySelector('ul');
                        if (errorList) {
                            const errorItem = document.createElement('li');
                            errorItem.textContent = 'An error occurred while processing your booking.';
                            errorList.appendChild(errorItem);
                        }
                    }
                });
            });
        

            document.getElementById('submit-voucher-btn').addEventListener('click', function(e) {
                e.preventDefault();
                const voucher = document.getElementById('voucher').value;

                fetch(`{% url 'retrive_voucher' %}`, {
                    method: 'POST',
                    body: JSON.stringify({ voucher_code: voucher }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('voucher-message').textContent = data.message;
                        document.getElementById('voucher-message').textContent += "Welcome " + data.return_data.client_name + ",";
                        // Fix the region selection
                        const regionSelect = document.querySelector('select[name="region"]');
                        console.log(regionSelect);
                        console.log(data.return_data.region_id);
                        const regionOption = regionSelect.querySelector(`option[value="${data.return_data.region_id}"]`);
                        console.log(regionOption);
                        if (regionOption) {
                            regionOption.selected = true;
                            regionSelect.dispatchEvent(new Event('change'));
                        }
                    } else {
                        document.getElementById('voucher-message').textContent = data.message;
                    }
                });

            });
        }
    });
</script>
{% endblock %}
{% endblock %}
