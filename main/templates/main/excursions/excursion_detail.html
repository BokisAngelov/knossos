{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .flatpickr-calendar {
        z-index: 9999 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Back button and actions -->
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'excursion_list' %}" class="inline-flex items-center text-blue font-semibold text-sm hover:opacity-80">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Excursions
        </a>
        {% if user.is_staff %}
        <div class="flex space-x-4">
            <a href="{% url 'availability_create' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Availability
            </a>
            {% if excursion.availabilities.exists %}
            <a href="{% url 'availability_detail' excursion.availabilities.first.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                View Availability
            </a>
            {% endif %}
            <a href="{% url 'excursion_update' excursion.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <button type="button" id="delete-excursion-btn" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Image Gallery Section -->
    <div class="grid grid-cols-1 {% if excursion.images.exists %}lg:grid-cols-5{% endif %} gap-4 p-4">
        <!-- Main Image -->
        <div class="{% if excursion.images.exists %}lg:col-span-2{% endif %} relative bg-gray-100 overflow-hidden">
            <img src="{% if excursion.intro_image %}{{ excursion.intro_image.url }}{% else %}{% static 'main/images/excursion-default.jpg' %}{% endif %}" 
                    alt="{{ excursion.title }}" 
                    class="w-full h-96 object-cover object-center cursor-pointer main-image bg-gray-100 block" 
                    data-image-url="{% if excursion.intro_image %}{{ excursion.intro_image.url }}{% else %}{% static 'main/images/excursion-default.jpg' %}{% endif %}"
                    data-alt="{{ excursion.title }}">
            <div class="absolute top-4 right-4">
                {% if excursion.guide %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                    Guided Excursion
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Gallery Thumbnails -->
        {% if excursion.images.exists %}
        <div class="{% if excursion.images.exists %}lg:col-span-3{% endif %} grid grid-cols-2 gap-2 h-96">
            {% for image in excursion.images.all|slice:":4" %}
            <div class="relative group cursor-pointer gallery-item bg-gray-100 overflow-hidden" 
                    data-image-url="{{ image.image.url }}" 
                    data-alt="{{ image.alt_text }}"
                    data-gallery-index="{{ forloop.counter }}">
                <div 
                        class="w-full h-full bg-center bg-cover transition-transform duration-300 group-hover:scale-102"
                        style="background-image: url('{{ image.image.url }}');">
                </div>
                
                <!-- Overlay for "View All" on 4th image if more images exist -->
                {% if forloop.counter == 4 and excursion.images.count > 4 %}
                <div class="absolute inset-0 bg-opacity-60 flex items-center justify-center">
                    <div class="text-center text-white">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-sm font-medium">+{{ excursion.images.count|add:"-3" }} more</p>
                    </div>
                </div>
                {% else %}
                <!-- Regular hover overlay -->
                <div class="absolute inset-0 bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                        </svg>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
        </div>
        {% endif %}
    </div>

    <!-- Main content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left column - Main content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Hero section with Gallery -->
            <div class="bg-white overflow-hidden">

                <div class="p-6">
                    <h1 class="text-4xl font-bold text-black mb-4 excursion-title">{{ excursion.title }}</h1>
                    
                    <!-- Time and Categories and Tags -->
                    
                    <div class="flex flex-wrap mb-4">
                        <svg class="mr-1 mt-1" width="17" height="19" viewBox="0 0 17 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.7714 14.1792L8.20032 18.6521C7.00672 19.3579 5.46354 18.9652 4.75437 17.7774L0.419474 10.5114C0.0748795 9.9349 -0.0849324 9.00055 0.0449148 8.33955L1.39333 1.62022C1.49821 1.10832 1.89773 0.54175 2.3522 0.273375C2.80667 0.00499891 3.50085 -0.0745198 4.00026 0.0795477L10.5775 2.12218C11.2218 2.32098 11.9659 2.90743 12.3155 3.48891L16.6504 10.7549C17.3595 11.9427 16.965 13.4784 15.7714 14.1842V14.1792ZM2.99644 1.34688C2.85161 1.43137 2.66184 1.70471 2.62688 1.86375L1.27846 8.58805C1.20855 8.94091 1.31342 9.56712 1.49821 9.87526L5.83311 17.1413C6.18769 17.7327 6.96178 17.9315 7.55608 17.5786L15.1272 13.1057C15.7215 12.7528 15.9212 11.9825 15.5667 11.3911L11.2318 4.12506C11.047 3.81693 10.5476 3.4243 10.203 3.31497L3.6307 1.27233C3.47088 1.22263 3.14127 1.26239 2.99644 1.34688ZM3.96031 2.9621C3.66066 3.13605 3.56078 3.5237 3.74057 3.8219C3.92036 4.12009 4.3049 4.21949 4.60455 4.04057C4.9042 3.86166 5.00408 3.47897 4.82429 3.18078C4.6445 2.88258 4.25996 2.78318 3.96031 2.9621ZM13.3043 11.2718C13.1245 10.9736 12.74 10.8742 12.4403 11.0531L7.03169 14.2488C6.73205 14.4227 6.63216 14.8104 6.81195 15.1086C6.99174 15.4068 7.37629 15.5062 7.67594 15.3273L13.0846 12.1316C13.3842 11.9577 13.4841 11.57 13.3043 11.2718ZM11.6962 8.57811C11.5164 8.27991 11.1319 8.18052 10.8322 8.35943L5.42359 11.5551C5.12394 11.729 5.02406 12.1167 5.20385 12.4149C5.38363 12.7131 5.76818 12.8125 6.06783 12.6336L11.4765 9.43791C11.7761 9.26396 11.876 8.8763 11.6962 8.57811Z" fill="#8E24AA"/>
                            </svg>
                            
                        <span class="font-normal text-purple lowercase">
                            {% for category in excursion.category.all %}
                                {{ category }}
                                {% if not forloop.last %}, {% endif %}
                            {% endfor %}
                            {% if excursion.category.all and excursion.tags.all %}, {% endif %}
                            {% for tag in excursion.tags.all %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        </span>
                    </div>

                    <div class="flex flex-wrap mb-1">
                        <svg class="mr-1" width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.14 0.5C11.9516 0.5 11.7633 0.50515 11.575 0.513906L11.6157 1.43991C11.7888 1.43167 11.9618 1.42704 12.14 1.42704C18.1871 1.42704 23.0838 6.38155 23.0838 12.5C23.0838 18.6185 18.1871 23.573 12.14 23.573C7.57922 23.573 3.67253 20.7558 2.02842 16.7438L3.43483 16.3163L0.969671 14.5498L0 17.3567L1.14783 17.0116C2.91054 21.3996 7.172 24.5 12.14 24.5C18.6859 24.5 24 19.1232 24 12.5C24 5.87682 18.6859 0.5 12.14 0.5ZM10.5722 0.605064C9.89523 0.695193 9.24369 0.841974 8.60742 1.0418L8.89247 1.92197C9.47275 1.73966 10.0785 1.60524 10.6944 1.52283L10.5722 0.605064ZM7.67084 1.38378C7.03966 1.64386 6.43902 1.95648 5.86893 2.317L6.35249 3.10034C6.87678 2.76867 7.4316 2.48077 8.01188 2.2418L7.67084 1.38378ZM5.03415 2.89485C4.49979 3.30012 4.00005 3.75012 3.54019 4.24009L4.20445 4.87253C4.62694 4.42086 5.09014 4.00678 5.57879 3.63339L5.33446 3.29502L5.03415 2.89485ZM8.57179 3.33674L8.34783 4.23494L19.3934 7.09228L19.6174 6.19614L8.57179 3.33674ZM2.87949 5.00644C2.46261 5.53176 2.08848 6.09828 1.76271 6.69056L2.55932 7.14378C2.86015 6.5927 3.20526 6.07253 3.59058 5.58326L2.87949 5.00644ZM9.37603 5.45966C9.17752 6.79871 9.51856 8.30258 10.0988 9.53863C10.4246 10.2288 10.8216 10.8365 11.2136 11.2794C11.4274 11.5215 11.6411 11.7069 11.8346 11.8408L11.5597 12.9326C11.3256 12.9532 11.0507 13.015 10.7453 13.1232C10.1905 13.3189 9.55419 13.6588 8.94337 14.1069C7.8439 14.9103 6.83606 16.0588 6.37794 17.3309L14.9039 19.5403C15.1024 18.2013 14.7614 16.6974 14.1811 15.4614C13.8554 14.7712 13.4583 14.1635 13.0664 13.7206C12.8526 13.4785 12.6388 13.2931 12.4454 13.1592L12.7203 12.0674C12.9493 12.0416 13.2293 11.985 13.5347 11.8768C14.0895 11.6811 14.7258 11.3412 15.3366 10.8931C16.4361 10.0897 17.4439 8.9412 17.902 7.6691L9.37603 5.45966ZM1.3102 7.60215C1.0389 8.22017 0.816458 8.8588 0.648484 9.52318L1.53824 9.73948C1.69247 9.13176 1.89659 8.54464 2.14651 7.97811L1.3102 7.60215ZM0.442842 10.5172C0.336458 11.1609 0.279958 11.8253 0.279958 12.5V12.5464L1.19618 12.5361V12.5C1.19618 11.8768 1.2481 11.2639 1.34634 10.6665L0.442842 10.5172ZM4.88653 17.9077L4.66257 18.8039L15.7082 21.6622L15.9321 20.7661L4.88653 17.9077Z" fill="#8E24AA"/>
                            </svg>
                            
                        <span class="text-header-grey">{{ excursion_availability.start_time|time:"H:i" }} - {{ excursion_availability.end_time|time:"H:i" }}</span>
                    </div>

                    <!-- Description -->
                    <div class="prose max-w-none mb-6">
                        {{ excursion.description|safe }}
                    </div>

                    <div class="prose max-w-none mb-6 border-t border-gray-200 pt-4">
                        <p class="text-sm text-gray-500 mb-4">*Note: Pickup points and prices are based on the region you have selected. <span class="text-sm text-gray-500 font-normal">(Selected Region: <span id="selected-region-name" class="pickup-region font-semibold">Please select a region</span>)</span></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-purple">Pickup Points</h2>
                                <p class="region-pickup-time">Pickup time: {{ excursion_availability.pickup_start_time|time:"H:i" }} - {{ excursion_availability.pickup_end_time|time:"H:i" }}</p>
                                <div class="flex gap-6" id="pickup-points-display">
                                    <div class="flex flex-col gap-2">
                                        <p class="text-sm text-gray-500">Select a region to view pickup points</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <h2 class="text-xl font-semibold text-purple">Price Details</h2>
                                    <div class="space-y-2 mt-4 w-60">
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Adult</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="adult-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Child</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="child-price">0.00</span></span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <span class="text-sm font-medium text-gray-600">Infant</span>
                                            <span class="text-base font-semibold text-gray-900">€<span id="infant-price">0.00</span></span>
                                        </div>
                                    </div>
                                    
                            </div>

                        </div>
                        
                        
                    </div>
                </div>
            </div>


            <!-- Feedback Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-8">
                <!-- Section Header with Overall Rating -->
                <div class="mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-3xl font-bold text-purple uppercase tracking-wide">Customer Reviews</h2>
                        {% if excursion.overall_rating %}
                        <div class="flex items-center gap-3 bg-gradient-to-r from-purple-50 to-blue-50 px-6 py-3 rounded-lg border border-purple-100">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="ml-2 text-2xl font-bold text-gray-900">{{ excursion.overall_rating|floatformat:1 }}</span>
                            </div>
                            <div class="border-l border-purple-200 pl-3">
                                <span class="text-sm font-medium text-gray-600">{{ excursion.feedback_entries.count }} review{{ excursion.feedback_entries.count|pluralize }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="h-1 w-24 bg-gradient-to-r from-purple to-blue rounded-full"></div>
                </div>

                <!-- Feedback Form -->
                {% if user.is_authenticated %}
                    {% if feedback_form %}
                        <div class="mb-10 bg-gradient-to-br from-gray-50 to-white border-2 border-purple-100 rounded-xl p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Share Your Experience
                            </h3>
                            <form method="post" class="space-y-5">
                                {% csrf_token %}
                                <input type="hidden" name="feedback_submit" value="1">
                                <input type="hidden" name="excursion" value="{{ excursion.pk }}">
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Your Rating *</label>
                                    <div class="mt-1">
                                        {{ feedback_form.rating }}
                                    </div>
                                    {% if feedback_form.rating.errors %}
                                        <div class="flex items-center gap-2 text-red-600 text-sm mt-2">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            <span>{{ feedback_form.rating.errors.0 }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Your Review *</label>
                                    <div class="mt-1">
                                        {{ feedback_form.comment }}
                                    </div>
                                    {% if feedback_form.comment.errors %}
                                        <div class="flex items-center gap-2 text-red-600 text-sm mt-2">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            <span>{{ feedback_form.comment.errors.0 }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <button type="submit" class="w-full inline-flex justify-center items-center px-6 py-3 border border-transparent shadow-md text-base font-semibold rounded-lg text-white bg-gradient-to-r from-purple to-blue hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple transition-all duration-200 transform hover:scale-[1.02]">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Submit Review
                                </button>
                            </form>
                        </div>
                    {% elif user_has_feedback %}
                        <div class="mb-10 p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg shadow-sm">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-green-800 font-medium">Thank you! You have already submitted a review for this excursion.</p>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="mb-10 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-gray-700">
                                <a href="{% url 'login' %}" class="font-semibold text-blue-600 hover:text-blue-700 hover:underline">Log in</a> 
                                <span class="text-gray-600">or</span> 
                                <a href="{% url 'signup' %}" class="font-semibold text-blue-600 hover:text-blue-700 hover:underline">sign up</a> 
                                <span class="text-gray-600">to share your experience</span>
                            </p>
                        </div>
                    </div>
                {% endif %}

                <!-- Feedback List -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">All Reviews</h3>
                    <div class="space-y-5">
                        {% for feedback in excursion.feedback_entries.all %}
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                            <!-- Review Header -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <!-- User Avatar -->
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple to-blue flex items-center justify-center text-white font-bold text-lg shadow-md">
                                        {{ feedback.author.username|first|upper }}
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-900">{{ feedback.author.username }}</p>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="flex items-center">
                                                {% for i in "12345"|make_list %}
                                                <svg class="w-4 h-4 {% if forloop.counter <= feedback.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                </svg>
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm text-gray-500">•</span>
                                            <span class="text-sm text-gray-500">{{ feedback.created_at|date:"F j, Y" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Review Content -->
                            <div class="pl-15">
                                <p class="text-gray-700 leading-relaxed">{{ feedback.comment }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                            </svg>
                            <p class="text-gray-500 text-lg font-medium mb-2">No reviews yet</p>
                            <p class="text-gray-400">Be the first to share your experience with this excursion!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column - Booking section -->
        <div class="lg:col-span-1">
            <div class="bg-white p-6 sticky top-6">
                <h2 class="text-2xl font-bold text-purple mb-4">Book this Excursion</h2>
                {% if not excursion.availabilities.exists %}
                    <p class="text-gray-500 text-center py-4 not-availability">The excursion is currently not available.</p>
                {% else %}
                
                <!-- Availability selection -->
                <form method="post" class="space-y-4" id="booking-form">
                    {% csrf_token %}
                    <input type="hidden" name="booking_submit" value="1">
                    {% for availability in excursion_availabilities.all %}
                        <input type="hidden" name="{{ availability.id }}-adult-price" value="{{ availability.adult_price }}">
                        <input type="hidden" name="{{ availability.id }}-child-price" value="{{ availability.child_price }}">
                        <input type="hidden" name="{{ availability.id }}-infant-price" value="{{ availability.infant_price }}">
                    {% endfor %}
                    <input type="hidden" name="availability_id" id="availability-id" value="">
                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-semibold text-header-grey">Region</label>
                        <select name="regions" id="regions" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.regions.errors %}border-red-500{% endif %}">
                            <option value="">Select a region</option>
                            {% for region in regions %}
                                <option value="{{ region.id }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                        {% if form.regions.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.regions.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
    {{ availability_dates_by_region|json_script:"available-dates-json" }}
    {{ pickup_points_by_region|json_script:"pickup-points-json" }}
    {{ region_availability_map|json_script:"region-availability-map-json" }}
    <input type="hidden" id="user-pickup-point-id" value="{{ user_pickup_point_id|default:'' }}">
    <input type="hidden" id="user-region-id" value="{{ user_region_id|default:'' }}">

                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-semibold text-header-grey">Pickup Point</label>
                        <select name="pickup_point" id="pickup-point" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.pickup_point.errors %}border-red-500{% endif %}" disabled>
                            <option value="">Select a region first</option>
                        </select>
                        {% if form.pickup_point.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.pickup_point.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-md font-semibold text-header-grey">Date</label>
                        <input type="text" id="date-picker" class="mt-1 block w-full form-fields-border rounded-md px-3 py-2 {% if form.date.errors %}border-red-500{% endif %}" placeholder="Select a region first" readonly>
                        <!-- <span id="remaining-seats" class="text-sm text-gray-500">Remaining seats: <span id="remaining-seats-count">{{ remaining_seats }}</span></span> -->
                        
                        {% if form.date.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.date.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-3 gap-4 py-4">
                        <div>
                            <label class="block text-md font-semibold text-header-grey">Adults</label>
                            <input type="number" name="adults" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.adults.errors %}border-red-500{% endif %}">
                            {% if form.adults.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.adults.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-semibold text-header-grey">Children</label>
                            <input type="number" name="children" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.children.errors %}border-red-500{% endif %}">
                            {% if form.children.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.children.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-md font-semibold text-header-grey">Infants</label>
                            <input type="number" name="infants" min="0" value="0" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.infants.errors %}border-red-500{% endif %}">
                            {% if form.infants.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.infants.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                    </div>
                    {% comment %} {% if user.is_staff or user.userprofile.role == 'representative' %} {% endcomment %}
                    <div class="flex flex-col gap-2">
                        <label class="block text-md font-semibold text-header-grey">Guest Name</label>
                        <input type="text" name="guest_name" id="guest-name" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.guest_name.errors %}border-red-500{% endif %}" value="{% if return_data.client_name is not None %}{{ return_data.client_name }}{% endif %}">
                        {% if form.guest_name.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.guest_name.errors.0 }}</p>
                        {% endif %}

                        <label class="block text-md font-semibold text-header-grey">Guest Email</label>
                        <input type="email" name="guest_email" id="guest-email" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.guest_email.errors %}border-red-500{% endif %}">
                        <span  id="guest-email-disabled" class="hidden text-sm text-gray-500">Your email is automatically filled in based on your profile. You cannot change it.</span>
                        {% if form.guest_email.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.guest_email.errors.0 }}</p>
                        {% endif %}

                    {% comment %} {% endif %} {% endcomment %}

                        <div class="mt-2">
                            <a href="#" id="clear-numbers" class="inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Clear</a>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="text-base font-semibold text-header-grey">Total</span>
                            <span class="text-lg font-bold text-blue-600">€<span id="total-price">0.00</span></span>
                            <input type="number" id="total-price-input" name="total_price" min="0" value="0" class="hidden">
                        </div>
                    </div>
                    
                    <div id="form-errors" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <ul class="list-disc list-inside text-sm text-red-600"></ul>
                    </div>

                    {% if user.is_staff or user.profile.role == 'representative' %}
                    <div class="flex flex-col gap-2">   
                        <label class="block text-md font-semibold text-header-grey">Partial Payment</label>
                        <input type="number" name="partial_payment" id="partial-payment" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <div class="hidden remaining-price-div">
                            <span class="text-sm font-medium text-header-grey">Remaining</span>
                            <span class="text-base font-semibold text-header-grey">€<span id="remaining-price">0.00</span>
                        </div>
                        <div class="flex flex-col gap-2 hidden" id="partial-paid-method-div">
                            <label class="block text-md font-semibold text-header-grey">Payment Method</label>
                            <select name="partial_paid_method" id="partial-paid-method" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md {% if form.partial_paid_method.errors %}border-red-500{% endif %}">
                                <option value="" selected>Select a payment method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                            </select>
                        </div>
                        
                        <div class="reservation-id-div">
                            <label class="block text-md font-semibold text-header-grey">Reservation ID</label>
                            <input type="text" name="voucher_code" id="voucher_code" class="mt-1 block w-full pl-3 pr-2 py-2 text-base form-fields-border focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        </div>
                    </div>
                    {% endif %}

                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:cursor-pointer hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg id="loading-spinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="submit-text">Book Now</span>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="gallery-lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
    <div class="relative max-w-4xl max-h-full p-4">
        <!-- Close button -->
        <button id="close-lightbox" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- Navigation arrows -->
        <button id="prev-image" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        
        <button id="next-image" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 z-10">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        
        <!-- Image container -->
        <div class="text-center">
            <img id="lightbox-image" src="" alt="" class="max-w-full max-h-[80vh] object-contain">
            <p id="lightbox-caption" class="text-white mt-4 text-lg"></p>
            <div id="lightbox-counter" class="text-gray-300 mt-2"></div>
        </div>
    </div>
</div>

<form id="delete-ex-form" action="{% url 'excursion_delete' excursion.pk %}" method="post" class="hidden">
    {% csrf_token %}
</form>

{% block extra_js %}
<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const availableDatesByRegion = JSON.parse(document.getElementById('available-dates-json').textContent);
    const pickupPointsByRegion = JSON.parse(document.getElementById('pickup-points-json').textContent);
    const regionAvailabilityMap = JSON.parse(document.getElementById('region-availability-map-json').textContent);

    const regionSelect = document.getElementById('regions');
    const pickupPointSelect = document.getElementById('pickup-point');
    const datePickerInput = document.getElementById('date-picker');
    const availabilityIdInput = document.getElementById('availability-id');
    
    const userRole = getCookie('user_role') ? getCookie('user_role') : '';
    const userId = getCookie('user_id') ? getCookie('user_id') : '';

    let picker = null;
    let currentAvailability = null;

    function calculateTotal() {
        const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
        const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
        const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
        const availabilityId = availabilityIdInput.value;

        if (!availabilityId) {
            document.getElementById('total-price').textContent = '0.00';
            document.getElementById('total-price-input').value = 0;
            return;
        }

        const adultPrice = parseFloat(document.querySelector(`input[name="${availabilityId}-adult-price"]`)?.value || 0);
        const childPrice = parseFloat(document.querySelector(`input[name="${availabilityId}-child-price"]`)?.value || 0);
        const infantPrice = parseFloat(document.querySelector(`input[name="${availabilityId}-infant-price"]`)?.value || 0);
        
        const total = (adults * adultPrice) + (children * childPrice) + (infants * infantPrice);
        document.getElementById('total-price').textContent = total.toFixed(2);
        document.getElementById('total-price-input').value = total;
    }

    // Helper: display price details and pickup points for selected region
    function displayRegionDetails(regionId) {
        // Update prices in the existing price details section
        const adultPriceEl = document.getElementById('adult-price');
        const childPriceEl = document.getElementById('child-price');
        const infantPriceEl = document.getElementById('infant-price');
        const selectedRegionNameEl = document.getElementById('selected-region-name');
        const pickupPointsDisplayEl = document.getElementById('pickup-points-display');
        const regionPickupTime = document.querySelector('.region-pickup-time');
        
        if (!regionId) {
            // Reset prices to 0.00 if no region selected
            if (adultPriceEl) adultPriceEl.textContent = '0.00';
            if (childPriceEl) childPriceEl.textContent = '0.00';
            if (infantPriceEl) infantPriceEl.textContent = '0.00';
            if (selectedRegionNameEl) selectedRegionNameEl.textContent = 'Please select a region';
            if (pickupPointsDisplayEl) {
                pickupPointsDisplayEl.innerHTML = '<div class="flex flex-col gap-2"><p class="text-sm text-gray-500">Select a region to view pickup points</p></div>';
                regionPickupTime.textContent = '';
            }
            return;
        }
        
        const availabilities = regionAvailabilityMap[regionId];
        if (availabilities && availabilities.length > 0) {
            // Use the first availability for this region
            currentAvailability = availabilities[0];

            regionPickupTime.textContent = `Pickup time: ${currentAvailability.pickup_start_time} - ${currentAvailability.pickup_end_time}`;
            
            // Display prices in the existing elements
            if (adultPriceEl) adultPriceEl.textContent = currentAvailability.adult_price.toFixed(2);
            if (childPriceEl) childPriceEl.textContent = currentAvailability.child_price.toFixed(2);
            if (infantPriceEl) infantPriceEl.textContent = currentAvailability.infant_price.toFixed(2);
            
            // Update selected region name
            const regionOption = regionSelect.querySelector(`option[value="${regionId}"]`);
            if (selectedRegionNameEl && regionOption) {
                selectedRegionNameEl.textContent = regionOption.textContent;
            }
            
            // Display pickup points for this region
            if (pickupPointsDisplayEl && currentAvailability.pickup_points) {
                let pickupPointsHTML = '<div class="flex flex-col gap-2"><ul class="pickup-points-list">';
                
                currentAvailability.pickup_points.forEach(point => {
                    pickupPointsHTML += `
                        <li>
                            <div class="flex items-center py-1">
                                <svg class="mr-2" width="17" height="19" viewBox="0 0 20 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9.75 23C14.125 18.6 18.5 14.66 18.5 9.8C18.5 4.93989 14.5825 1 9.75 1C4.91751 1 1 4.93989 1 9.8C1 14.66 5.375 18.6 9.75 23Z" stroke="#8E24AA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9.75 13.2222C11.8211 13.2222 13.5 11.5806 13.5 9.55552C13.5 7.53048 11.8211 5.88885 9.75 5.88885C7.67887 5.88885 6 7.53048 6 9.55552C6 11.5806 7.67887 13.2222 9.75 13.2222Z" stroke="#8E24AA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <a href="#">${point.name}</a>
                            </div>
                        </li>
                    `;
                });
                
                pickupPointsHTML += '</ul></div>';
                pickupPointsDisplayEl.innerHTML = pickupPointsHTML;
            }
        }
    }

    // Helper: update pickup points dropdown for selected region
    function updatePickupPoints(regionId) {
        pickupPointSelect.innerHTML = '<option value="">Select a pickup point</option>';
        
        if (!regionId) {
            pickupPointSelect.disabled = true;
            return;
        }
        
        const pickupPoints = pickupPointsByRegion[regionId];
        if (pickupPoints && pickupPoints.length > 0) {
            // Sort points alphabetically
            const sortedPoints = [...pickupPoints].sort((a, b) => a.name.localeCompare(b.name));
            
            // Add options
            sortedPoints.forEach(point => {
                const option = document.createElement('option');
                option.value = point.id;
                option.textContent = point.name;
                pickupPointSelect.appendChild(option);
            });
            
            pickupPointSelect.disabled = false;
        } else {
            pickupPointSelect.disabled = true;
            console.log('No pickup points found for region:', regionId);
        }
    }

    // Helper: update date picker for selected region
    function updateDatePicker(regionId) {
        const availableDates = availableDatesByRegion[regionId] || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Set to start of today
        
        // Filter out past dates
        const futureAvailableDates = availableDates.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= today;
        });
        
        // Destroy existing picker
        if (picker) {
            picker.destroy();
            picker = null;
        }
        
        // Clear values
        datePickerInput.value = '';
        availabilityIdInput.value = '';
        
        // Initialize new picker only if there are available dates
        if (futureAvailableDates.length > 0) {
            picker = flatpickr(datePickerInput, {
                enable: futureAvailableDates.map(item => item.date),
                dateFormat: "Y-m-d",
                minDate: "today",
                disableMobile: false,
                clickOpens: true,
                allowInput: false,
                static: false,
                onChange: function(selectedDates, dateStr) {
                    const selectedDate = futureAvailableDates.find(item => item.date === dateStr);
                    if (selectedDate && selectedDate.availability_id) {
                        availabilityIdInput.value = selectedDate.availability_id;
                        calculateTotal();
                    }
                },
                onReady: function(selectedDates, dateStr, instance) {
                    console.log('Flatpickr ready with', futureAvailableDates.length, 'available dates');
                }
            });
            
            // Make input clickable
            datePickerInput.placeholder = 'Click to select a date';
            datePickerInput.disabled = false;
        } else {
            datePickerInput.placeholder = 'No available dates for this region';
            datePickerInput.disabled = true;
        }
    }

    // On region change, update everything
    regionSelect.addEventListener('change', function() {
        const regionId = this.value;
        displayRegionDetails(regionId);
        updatePickupPoints(regionId);
        updateDatePicker(regionId);
        calculateTotal();
    });


    document.addEventListener('DOMContentLoaded', function() {

        // Initialize with no region selected - user must select region first
        pickupPointSelect.disabled = true;
        datePickerInput.disabled = true;
        datePickerInput.placeholder = 'Select a region first';

        const notAvailability = document.querySelector('.not-availability');
        const bookingForm = document.getElementById('booking-form');
        const formErrors = document.getElementById('form-errors');
        const voucherCode = getCookie('voucher_code');
        
        // console.log('voucherCode: ' + voucherCode);
        
        if (!notAvailability) {
            // let picker = null;

            if (userRole == 'client') {
                console.log('userRole: ' + userRole);
                console.log('userId: ' + userId);
                fetch('/get_user_details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                    // body: JSON.stringify({
                    //     user_id: userId
                    // })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('User profile data:', data.user_profile);
                    document.querySelector('#guest-name').value = data.user_profile.name;
                    document.querySelector('#guest-email').value = data.user_profile.email;
                    document.querySelector('#guest-email').disabled = true;
                    document.querySelector('#guest-email-disabled').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            

            function checkVoucher() {
                const voucherInput = getCookie('voucher_code');
                // console.log('voucherInput: ' + voucherInput);
                if (voucherInput) {
                    fetch('/check_voucher/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            voucher_code: voucherInput
                        })
                    })
                    .then(response => {
                        // Check if response is ok and is JSON
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const contentType = response.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            throw new Error("Response is not JSON");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // console.log('data.return_data: ' + data.return_data);
                            // console.log('data.message: ' + data.message);
                            // console.log('data.success: ' + data.success);
                            
                            document.querySelector('#guest-name').value = data.return_data.client_name;
                            document.querySelector('#guest-email').value = data.return_data.client_email;

                            // Pre-select pickup point if available from voucher
                            if (data.return_data.pickup_point_id) {
                                // We'll set this after region selection
                                setTimeout(() => {
                                    const pickupPointOption = pickupPointSelect.querySelector(`option[value="${data.return_data.pickup_point_id}"]`);
                                    if (pickupPointOption) {
                                        pickupPointSelect.value = data.return_data.pickup_point_id;
                                    }
                                }, 100);
                            } 

                        } else {
                            console.log('Voucher check failed:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Voucher check error:', error.message);
                        // Silently fail - voucher checking is optional
                    });
                }
            
            }
            checkVoucher();
            
            // Auto-select user's pickup point if available in this excursion
            function autoSelectUserPickupPoint() {
                const userPickupPointId = document.getElementById('user-pickup-point-id')?.value;
                const userRegionId = document.getElementById('user-region-id')?.value;
                
                if (userPickupPointId && userRegionId) {
                    console.log('Auto-selecting user pickup point:', userPickupPointId, 'in region:', userRegionId);
                    
                    // Select the region
                    regionSelect.value = userRegionId;
                    
                    // Trigger region change to populate pickup points and dates
                    displayRegionDetails(userRegionId);
                    updatePickupPoints(userRegionId);
                    updateDatePicker(userRegionId);
                    
                    // Wait a bit for the pickup points to be populated, then select the pickup point
                    setTimeout(() => {
                        const pickupPointOption = pickupPointSelect.querySelector(`option[value="${userPickupPointId}"]`);
                        if (pickupPointOption) {
                            pickupPointSelect.value = userPickupPointId;
                            console.log('User pickup point auto-selected successfully');
                        } else {
                            console.log('User pickup point not found in dropdown');
                        }
                    }, 100);
                }
            }
            
            // Call auto-select after a small delay to ensure DOM is ready
            setTimeout(autoSelectUserPickupPoint, 200);
            
            // Calculate initial total
            calculateTotal();

            // Add event listeners to number inputs and date picker
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', calculateTotal);
                input.addEventListener('input', calculateTotal);    
            });

            // Recalculate when date changes (which sets availability_id)
            datePickerInput.addEventListener('change', calculateTotal);

            document.querySelector('#clear-numbers').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = 0;
                });
                calculateTotal();
            });
        
            if (document.querySelector('#partial-payment')) {
                
                document.querySelector('#partial-payment').addEventListener('change', function(e) {
                    e.preventDefault();
                    const partialPayment = document.querySelector('#partial-payment').value;
                    // const partialPaidMethod = document.querySelector('#partial-paid-method').value;
                    const total = document.querySelector('#total-price').textContent;

                    if (partialPayment <= 0) {
                        document.querySelector('.remaining-price-div').classList.add('hidden');
                        document.querySelector('#partial-paid-method-div').classList.add('hidden');
                        return;
                    } else {
                        const remaining = total - partialPayment;
                        document.querySelector('.remaining-price-div').classList.remove('hidden');
                        document.querySelector('#remaining-price').textContent = remaining.toFixed(2);
                        document.querySelector('#partial-paid-method-div').classList.remove('hidden');
                        // document.querySelector('#partial-paid-method').value = partialPaidMethod;
                    }
                });
            }
            if (document.getElementById('delete-excursion-btn')) {
                // Delete excursion confirmation
                document.getElementById('delete-excursion-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    const excursionTitle = document.querySelector('.excursion-title').textContent;
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Do you want to delete excursion "${excursionTitle}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('delete-ex-form').submit();
                        }
                    });
                });
            }
            

            // Booking form submission
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get submit button and loading elements
                const submitButton = document.getElementById('submit-button');
                const loadingSpinner = document.getElementById('loading-spinner');
                const submitText = document.getElementById('submit-text');
                
                // Show loading state
                submitButton.disabled = true;
                loadingSpinner.classList.remove('hidden');
                submitText.textContent = 'Processing...';
                
                // Clear previous errors
                if (formErrors) {
                    formErrors.classList.add('hidden');
                    const errorList = formErrors.querySelector('ul');
                    if (errorList) {
                        errorList.innerHTML = '';
                    }
                }
                // Clear previous error styling
                document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
                document.querySelectorAll('.text-red-600').forEach(el => {
                    if (el.tagName === 'P' && el.classList.contains('text-red-600')) {
                        el.remove();
                    }
                });
                
                // Get form values using consistent element references
                const selectedDate = datePickerInput.value.trim();
                const availabilityId = availabilityIdInput.value.trim();
                const regionId = regionSelect.value;
                const pickupPointId = pickupPointSelect.value;
                const adults = parseInt(document.querySelector('input[name="adults"]').value) || 0;
                const children = parseInt(document.querySelector('input[name="children"]').value) || 0;
                const infants = parseInt(document.querySelector('input[name="infants"]').value) || 0;
                const guestEmail = document.querySelector('#guest-email').value.trim();
                const guestName = document.querySelector('#guest-name').value.trim();
                const voucherInput = document.querySelector('#voucher_code');
                const voucherCode = (voucherInput && voucherInput.value) ? voucherInput.value.trim() : "";
                const partialPaymentInput = document.querySelector('#partial-payment');
                const partialPayment = (partialPaymentInput && partialPaymentInput.value) ? partialPaymentInput.value.trim() : "";
                const partialPaidMethodInput = document.querySelector('#partial-paid-method');
                const partialPaidMethod = (partialPaidMethodInput && partialPaidMethodInput.value) ? partialPaidMethodInput.value.trim() : '';
                // Validate form
                let errors = [];

                // Validate region
                if (!regionId) {
                    errors.push({ field: 'regions', message: 'Please select a region.' });
                    regionSelect.classList.add('border-red-500');
                    const errorDiv = document.createElement('p');
                    errorDiv.className = 'mt-1 text-sm text-red-600';
                    errorDiv.textContent = 'Please select a region.';
                    regionSelect.parentNode.appendChild(errorDiv);
                }

                // Validate pickup point
                if (!pickupPointId) {
                    errors.push({ field: 'pickup_point', message: 'Please select a pickup point.' });
                    pickupPointSelect.classList.add('border-red-500');
                    const errorDiv = document.createElement('p');
                    errorDiv.className = 'mt-1 text-sm text-red-600';
                    errorDiv.textContent = 'Please select a pickup point.';
                    pickupPointSelect.parentNode.appendChild(errorDiv);
                }

                // Validate date
                if (!selectedDate || !availabilityId) {
                    errors.push({ field: 'date', message: 'Please select a date.' });
                    datePickerInput.classList.add('border-red-500');
                    const errorDiv = document.createElement('p');
                    errorDiv.className = 'mt-1 text-sm text-red-600';
                    errorDiv.textContent = 'Please select a date.';
                    datePickerInput.parentNode.appendChild(errorDiv);
                }

                if (adults + children + infants === 0) {
                    errors.push({ field: 'participants', message: 'Please select at least one participant (adult, child, or infant).' });
                    ['adults', 'children', 'infants'].forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                        }
                    });
                    const adultsInput = document.querySelector('input[name="adults"]');
                    if (adultsInput) {
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select at least one participant.';
                        adultsInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (!guestName) {
                    errors.push({ field: 'guest-name', message: 'Please enter your name.' });
                    const guestNameInput = document.querySelector('#guest-name');
                    if (guestNameInput) {
                        guestNameInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please enter your name.';
                        guestNameInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (!guestEmail) {
                    errors.push({ field: 'guest-email', message: 'Please enter your email.' });
                    const guestEmailInput = document.querySelector('#guest-email');
                    if (guestEmailInput) {
                        guestEmailInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please enter your email.';
                        guestEmailInput.parentNode.appendChild(errorDiv);
                    }
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(guestEmail)) {
                    errors.push({ field: 'guest-email', message: 'Please enter a valid email address.' });
                    const guestEmailInput = document.querySelector('#guest-email');
                    if (guestEmailInput) {
                        guestEmailInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please enter a valid email address.';
                        guestEmailInput.parentNode.appendChild(errorDiv);
                    }
                }

                // Validate partial payment for admin/staff
                if ((userRole === 'admin' || userRole === 'representative') && partialPayment && parseFloat(partialPayment) > 0 && !partialPaidMethod) {
                    errors.push({ field: 'partial-paid-method', message: 'Please select a payment method for partial payment.' });
                    const partialPaidMethodInput = document.querySelector('#partial-paid-method');
                    if (partialPaidMethodInput) {
                        partialPaidMethodInput.classList.add('border-red-500');
                        const errorDiv = document.createElement('p');
                        errorDiv.className = 'mt-1 text-sm text-red-600';
                        errorDiv.textContent = 'Please select a payment method for partial payment.';
                        partialPaidMethodInput.parentNode.appendChild(errorDiv);
                    }
                }

                if (errors.length > 0) {
                    // Hide loading state if validation fails
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    submitText.textContent = 'Book Now';
                    return;
                }

                // If validation passes, submit the form
                const formData = new FormData(bookingForm);
                formData.append('selected_date', selectedDate);
                formData.append('availability_id', availabilityId);
                formData.append('regions', regionId);
                formData.append('pickup_point', pickupPointId);
                formData.append('voucher_code', voucherCode || "");
                formData.append('partial_payment', partialPayment || "");
                formData.append('partial_paid_method', partialPaidMethod || "");
                // Submit form via AJAX
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    // console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);

                    if (data.success) {
                        console.log('Redirecting to:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        // Hide loading state
                        submitButton.disabled = false;
                        loadingSpinner.classList.add('hidden');
                        submitText.textContent = 'Book Now';
                        
                        // Map field names to actual input selectors for error display
                        const fieldSelectors = {
                            'regions': '#regions',
                            'pickup_point': '#pickup-point',
                            'date': '#date-picker',
                            'guest_name': '#guest-name',
                            'guest_email': '#guest-email',
                            'adults': 'input[name="adults"]',
                            'children': 'input[name="children"]',
                            'infants': 'input[name="infants"]',
                            'partial_paid_method': '#partial-paid-method'
                        };
                        
                        // Display server-side validation errors
                        if (data.errors) {
                            Object.keys(data.errors).forEach(field => {
                                const selector = fieldSelectors[field] || `[name="${field}"]`;
                                const input = document.querySelector(selector);
                                
                                if (input) {
                                    input.classList.add('border-red-500');
                                    const errorDiv = document.createElement('p');
                                    errorDiv.className = 'mt-1 text-sm text-red-600';
                                    errorDiv.textContent = Array.isArray(data.errors[field]) ? data.errors[field][0] : data.errors[field];
                                    input.parentNode.appendChild(errorDiv);
                                }
                            });
                        }
                        
                        // Display general error message
                        if (data.message && formErrors) {
                            formErrors.classList.remove('hidden');
                            const errorList = formErrors.querySelector('ul');
                            if (errorList) {
                                errorList.innerHTML = '';
                                const errorItem = document.createElement('li');
                                errorItem.textContent = data.message;
                                errorList.appendChild(errorItem);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Hide loading state
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    submitText.textContent = 'Book Now';
                    
                    if (formErrors) {
                        formErrors.classList.remove('hidden');
                        const errorList = formErrors.querySelector('ul');
                        if (errorList) {
                            const errorItem = document.createElement('li');
                            errorItem.textContent = 'An error occurred while processing your booking. Please try again.';
                            errorList.appendChild(errorItem);
                        }
                    }
                    // document.getElementById('form-errors').removeAttribute('class', 'hidden');
                    document.getElementById('form-errors').textContent = error;
                    console.log('error.message:', error.message);
                });
            });
        }
        
        // Gallery lightbox functionality
        const galleryItems = document.querySelectorAll('.gallery-item');
        const mainImage = document.querySelector('.main-image');
        const lightbox = document.getElementById('gallery-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const lightboxCounter = document.getElementById('lightbox-counter');
        const closeLightbox = document.getElementById('close-lightbox');
        const prevImage = document.getElementById('prev-image');
        const nextImage = document.getElementById('next-image');
        
        let currentImageIndex = 0;
        
        // Build images array including main image and gallery images
        const images = [];
        
        // Add main image first
        if (mainImage) {
            images.push({
                url: mainImage.dataset.imageUrl,
                alt: mainImage.dataset.alt || ''
            });
        }
        
        // Add gallery images
        Array.from(galleryItems).forEach(item => {
            images.push({
                url: item.dataset.imageUrl,
                alt: item.dataset.alt || ''
            });
        });
        
        function showLightbox(index) {
            if (images.length === 0) return;
            
            currentImageIndex = index;
            lightboxImage.src = images[index].url;
            lightboxImage.alt = images[index].alt;
            lightboxCaption.textContent = images[index].alt;
            lightboxCounter.textContent = `${index + 1} / ${images.length}`;
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function hideLightbox() {
            lightbox.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        function showNextImage() {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            showLightbox(currentImageIndex);
        }
        
        function showPrevImage() {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            showLightbox(currentImageIndex);
        }
        
        // Event listener for main image
        if (mainImage) {
            mainImage.addEventListener('click', () => showLightbox(0));
        }
        
        // Event listeners for gallery thumbnails
        galleryItems.forEach((item, index) => {
            item.addEventListener('click', () => {
                // Add 1 to index because main image is at index 0
                showLightbox(index + 1);
            });
        });
        
        if (closeLightbox) {
            closeLightbox.addEventListener('click', hideLightbox);
        }
        
        if (prevImage) {
            prevImage.addEventListener('click', showPrevImage);
        }
        
        if (nextImage) {
            nextImage.addEventListener('click', showNextImage);
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (lightbox && !lightbox.classList.contains('hidden')) {
                switch(e.key) {
                    case 'Escape':
                        hideLightbox();
                        break;
                    case 'ArrowLeft':
                        showPrevImage();
                        break;
                    case 'ArrowRight':
                        showNextImage();
                        break;
                }
            }
        });
        
        // Close lightbox when clicking outside image
        if (lightbox) {
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) {
                    hideLightbox();
                }
            });
        }
    });
</script>
{% endblock %}
{% endblock %}
