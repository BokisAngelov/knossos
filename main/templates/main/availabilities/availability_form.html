{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .auth-input-field input, 
  .auth-input-field select, 
  .auth-input-field textarea {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    outline: none;
  }
  .auth-input-field input:focus, 
  .auth-input-field select:focus, 
  .auth-input-field textarea:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
  }
  
  /* Style for checkbox lists */
  .checkbox-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .checkbox-list label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
  }
  
  .checkbox-list label:hover {
    background-color: #f3f4f6;
  }
  
  .checkbox-list input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    width: 100%;
  }

  .pickupgroup-grid {
    display: flex;
    gap: 1.5rem;
    width: 100%;
  }
  .pickupgroup-col {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1 1 0;
  }

  /* Pickup Points Styling */
  .pickup-points-container {
    max-height: 500px;
    overflow-y: auto;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
  }
  
  .pickup-group-section {
    margin-bottom: 1rem;
  }
  
  .pickup-points-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .pickup-point-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .pickup-point-checkbox {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }
  
  .pickup-point-label {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background-color: #e0f2fe;
    border-radius: 0.375rem;
    text-align: center;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .pickup-point-label:hover {
    background-color: #bae6fd;
  }
  
  /* Region Selection Styling */
  .region-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.5rem;
    padding: 0.5rem;
  }
  
  .region-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .region-checkbox {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }
  
  .region-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .region-label {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background-color: #e0e7ff;
    border-radius: 0.375rem;
    text-align: center;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .region-label:hover {
    background-color: #c7d2fe;
  }
  
  .region-item.disabled .region-label {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f3f4f6;
  }
</style>

<div class="flex justify-center items-center">
  <div class="w-full max-w-4xl p-6 pl-0">
    <a href="{% if availability %}{% url 'availability_detail' availability.id %}{% else %}{% url 'availability_list' %}{% endif %}" class="inline-flex items-left text-sm font-semibold text-blue hover:opacity-80">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      {% if availability %}Back to Availability{% else %}Back to Availability List{% endif %}
    </a>
  </div>
</div>

<div class="flex justify-center items-center min-h-[80vh]">
  <div class="bg-white rounded-lg w-full max-w-4xl p-6">
    <div class="mb-6">
      <h1 class="text-3xl font-bold page-header-color">
        {% if availability %}Edit{% else %}Add{% endif %} Availability
      </h1>
      <p class="text-md font-semibold text-purple">
        {% if availability %}
          Update availability for {{ availability.excursion.title }}
        {% else %}
          Create a new availability period
        {% endif %}
      </p>
    </div>

    {% if messages %}
    <div class="mb-6">
      {% for message in messages %}
        <div class="p-4 mb-4 rounded-md {% if message.tags == 'error' %}bg-red-50 text-red-700{% else %}bg-green-50 text-green-700{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    {% if form.non_field_errors %}
    <div class="error-message">
        {% for error in form.non_field_errors %}
            <p class="text-red-600">{{ error }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" class="space-y-4" id="availability-form" action="{% if availability %}{% url 'availability_update' availability.id %}{% else %}{% url 'availability_create' %}{% endif %}">
      {% csrf_token %}

      <!-- Excursion & Status -->
      <div class="flex gap-4">
        <div class="flex-[4_4_0%] space-y-1">
          <label for="{{ form.excursion.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.excursion.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.excursion }}</div>
          {% if form.excursion.errors %}<div class="text-red-500 text-xs mt-1">{{ form.excursion.errors }}</div>{% endif %}
        </div>
        <div class="flex-[1_1_0%] space-y-1">
          <label for="{{ form.status.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.status.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.status }}</div>
          {% if form.status.errors %}<div class="text-red-500 text-xs mt-1">{{ form.status.errors }}</div>{% endif %}
        </div>
      </div>

      <!-- Dates: Start/End -->
      <div class="flex gap-4">
        <div class="flex-1 space-y-1">
          <label for="{{ form.start_date.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.start_date.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.start_date }}</div>
          {% if form.start_date.errors %}<div class="text-red-500 text-xs mt-1">{{ form.start_date.errors }}</div>{% endif %}
        </div>
        <div class="flex-1 space-y-1">
          <label for="{{ form.end_date.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.end_date.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.end_date }}</div>
          {% if form.end_date.errors %}<div class="text-red-500 text-xs mt-1">{{ form.end_date.errors }}</div>{% endif %}
        </div>
      </div>

      <!-- Times: Start/End -->
      <div class="flex gap-4">
        <div class="flex-1 space-y-1">
          <label for="{{ form.start_time.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.start_time.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.start_time }}</div>
          {% if form.start_time.errors %}<div class="text-red-500 text-xs mt-1">{{ form.start_time.errors }}</div>{% endif %}
        </div>
        <div class="flex-1 space-y-1">
          <label for="{{ form.end_time.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.end_time.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.end_time }}</div>
          {% if form.end_time.errors %}<div class="text-red-500 text-xs mt-1">{{ form.end_time.errors }}</div>{% endif %}
        </div>
      </div>

      <!-- Regions (Multiple Selection) -->
      <div class="space-y-1">
        <label for="{{ form.regions.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.regions.label }}</label>
        <div class="w-full">{{ form.regions }}</div>
        {% if form.regions.errors %}<div class="text-red-500 text-xs mt-1">{{ form.regions.errors }}</div>{% endif %}
      </div>

      <!-- Max Guests -->
      <div class="space-y-1">
        <label for="{{ form.max_guests.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.max_guests.label }}</label>
        <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.max_guests }}</div>
        {% if form.max_guests.errors %}<div class="text-red-500 text-xs mt-1">{{ form.max_guests.errors }}</div>{% endif %}
      </div>

      <!-- Prices: 3 columns + Discount -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="space-y-1">
          <label for="{{ form.adult_price.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.adult_price.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.adult_price }}</div>
          {% if form.adult_price.errors %}<div class="text-red-500 text-xs mt-1">{{ form.adult_price.errors }}</div>{% endif %}
        </div>
        <div class="space-y-1">
          <label for="{{ form.child_price.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.child_price.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.child_price }}</div>
          {% if form.child_price.errors %}<div class="text-red-500 text-xs mt-1">{{ form.child_price.errors }}</div>{% endif %}
        </div>
        <div class="space-y-1">
          <label for="{{ form.infant_price.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.infant_price.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.infant_price }}</div>
          {% if form.infant_price.errors %}<div class="text-red-500 text-xs mt-1">{{ form.infant_price.errors }}</div>{% endif %}
        </div>
        <div class="space-y-1">
          <label for="{{ form.discount.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.discount.label }}</label>
          <div class="w-full auth-input-field rounded-lg border form-fields-border">{{ form.discount }}</div>
          {% if form.discount.errors %}<div class="text-red-500 text-xs mt-1">{{ form.discount.errors }}</div>{% endif %}
        </div>
      </div>


      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <!-- Weekdays -->
        <div class="md:col-span-1 space-y-1">
          <label for="{{ form.weekdays.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.weekdays.label }}</label>
          <div class="w-full overflow-x-auto">
            <div class="flex flex-row flex-wrap gap-2">
              {{ form.weekdays }}
            </div>
          </div>
          {% if form.weekdays.errors %}<div class="text-red-500 text-xs mt-1">{{ form.weekdays.errors }}</div>{% endif %}
        </div>

        <!-- Pickup Points -->
        <div class="md:col-span-2 space-y-1">
          <label for="{{ form.pickup_points.id_for_label }}" class="block text-md font-semibold text-header-grey">{{ form.pickup_points.label }}</label>
          <div class="w-full">
            {{ form.pickup_points }}
          </div>
          {% if form.pickup_points.errors %}<div class="text-red-500 text-xs mt-1">{{ form.pickup_points.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="mt-6 flex gap-4">
        <button type="submit" class="flex-1 bg-blue-primary text-white font-medium py-2 px-4 rounded-md hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-blue-primary focus:ring-offset-2">
          {% if availability %}Update{% else %}Create{% endif %} Availability
        </button>
        <a href="{% if availability %}{% url 'availability_detail' availability.id %}{% else %}{% url 'availability_list' %}{% endif %}" 
           class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md text-center focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  //  get csrf token for ajax requests
  function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
document.addEventListener('DOMContentLoaded', function() {
  
    const weekdaysCheckboxes = document.querySelectorAll('input[name="weekdays"]');
    const allPriceFields = document.querySelectorAll('.price-field');
    const excursionSelect = document.querySelector('#id_excursion');
    const startDateInput = document.querySelector('#id_start_date');
    const endDateInput = document.querySelector('#id_end_date');
    const availabilityId = {{ availability.id|default:"null" }};

    // Function to update available regions based on excursion and date range
    function updateAvailableRegions() {
        const selectedExcursion = excursionSelect.value;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (!selectedExcursion || !startDate || !endDate) {
            return;
        }
        
        fetch('/get_available_regions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                excursion_id: selectedExcursion,
                start_date: startDate,
                end_date: endDate,
                current_availability_id: availabilityId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.regions) {
                // Reset all regions first
                document.querySelectorAll('.region-checkbox').forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.closest('.region-item').classList.remove('disabled');
                });
                
                // Disable conflicting regions
                data.regions.forEach(region => {
                    const regionCheckbox = document.querySelector(`.region-checkbox[data-region-id="${region.id}"]`);
                    if (regionCheckbox && region.disabled) {
                        regionCheckbox.disabled = true;
                        regionCheckbox.checked = false;
                        regionCheckbox.closest('.region-item').classList.add('disabled');
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error fetching available regions:', error);
        });
    }

    // Listen for changes to excursion, start date, and end date
    if (excursionSelect) {
        excursionSelect.addEventListener('change', updateAvailableRegions);
    }
    if (startDateInput) {
        startDateInput.addEventListener('change', updateAvailableRegions);
    }
    if (endDateInput) {
        endDateInput.addEventListener('change', updateAvailableRegions);
    }

    // Initial call if editing an existing availability
    if (availabilityId) {
        updateAvailableRegions();
    }

  
    // Form submission handling
    const form = document.getElementById('availability-form');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Submit form using fetch
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: data.message || 'Availability saved successfully.',
                    icon: 'success',
                    confirmButtonColor: '#3085d6'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = data.redirect_url;
                    }
                });
            } else {
                // Show error message with detailed errors
                let errorMessage = data.message;
                if (data.errors && data.errors.length > 0) {
                    errorMessage += '\n\n' + data.errors.join('\n');
                }
                
                Swal.fire({
                    title: 'Error!',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonColor: '#3085d6'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while saving the availability. Please check the form for errors and try again.',
                icon: 'error',
                confirmButtonColor: '#3085d6'
            });
        });
    });
});
</script>
{% endblock %}
